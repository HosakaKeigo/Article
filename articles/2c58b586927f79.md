---
title: "ã€ç¯€é›»ã®å¤ã€‘SwitchBotã§æ±äº¬é›»åŠ›ã®é›»åŠ›çŠ¶æ³ã«å¿œã˜ã¦ã‚¨ã‚¢ã‚³ãƒ³ã®æ¸©åº¦ã‚’èª¿æ•´ã™ã‚‹ï¼ˆã¤ã„ã§ã«é›»æ°—ã®ç…§åº¦ã‚’ä¸‹ã’ã‚‹ï¼‰"
emoji: "ğŸ’¡"
type: "tech"
topics:
  - "iot"
  - "api"
  - "googleappsscript"
  - "switchbot"
  - "ç¯€é›»"
published: true
published_at: "2022-07-01 15:08"
---

## ã¯ã˜ã‚ã«
2022å¹´ã®æ¢…é›¨ã€‚å¤§åœ°ã‚’æ½¤ã™é›¨ã¯ã©ã“ã¸ã‚„ã‚‰ã€ã‚«ãƒ³ã‚«ãƒ³ç…§ã‚Šã®å¤ªé™½ã°ã‹ã‚ŠãŒé™ã‚Šæ³¨ãã€çŒ›æš‘ãŒç¶šãã¾ã™ã€‚æ—¥çµŒå¹³å‡æ ªä¾¡ã¨ã¯è£è…¹ã«é«˜æ­¢ã¾ã‚Šã™ã‚‹é›»åŠ›ä½¿ç”¨é‡ã€è€³æ–°ã—ã‹ã£ãŸã€Œ**é›»åŠ›éœ€çµ¦ã²ã£è¿«æ³¨æ„å ±**ã€ã¯ã€ã„ã¤ã—ã‹è€³ã‚¿ã‚³â€¦

ã•ã¦å¸‚äº•ã®æ°‘ã«ä½•ãŒã§ãã‚‹ã‹ã€‚ã‚€ã‚ã‚“ã€Œ**ç¯€é›»**ã€ã§ã™ã€‚[^1]

é›»åŠ›ã²ã£è¿«ã®èƒŒæ™¯ã¨ã—ã¦ã€ã€Œ[é›»åŠ›éœ€çµ¦ã«é–¢ã™ã‚‹æ¤œè¨ä¼šåˆï¼ˆ2022/06/07ï¼‰](https://www.meti.go.jp/press/2022/06/20220607003/20220607003.html)ã€ã§ã‚‚ã€Œã‚³ãƒ­ãƒŠã®å½±éŸ¿ã«ã‚ˆã‚‹å›½æ°‘ç”Ÿæ´»ã®è¡Œå‹•æ§˜å¼ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«ã®å¤‰åŒ–ã«ã‚ˆã‚‹å½±éŸ¿ã€ãŒæŒ™ã’ã‚‰ã‚Œã¦ã„ã¾ã™ãŒã€ãƒ†ãƒ¬ãƒ¯ãƒ¼ã‚¯ã®æ™®åŠã§é›»æ°—ä»£ãŒä¸ŠãŒã£ãŸã¨ã„ã†æ–¹ã‚‚å¤šã„ã§ã—ã‚‡ã†ã€‚ï¼ˆã¨ãã«ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢æ—ã¯...ï¼‰

æ±äº¬é›»åŠ›ã¯ã€ç¯€é›»ã§ãƒã‚¤ãƒ³ãƒˆãŒã‚‚ã‚‰ãˆã‚‹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã€Œ[å¤ã®ç¯€é›»ãƒãƒ£ãƒ¬ãƒ³ã‚¸2022](https://www.tepco.co.jp/ep/private/savingenergy/lp/challenge.html)ã€ã‚’å®Ÿæ–½ã—ã€ã“ã‚Œã«ãŠå›½ã‚‚ä¹—ã‚Šæ°—ã§[ç¯€é›»ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®å‚åŠ è€…ã«**2,000å††ç›¸å½“ã®ãƒã‚¤ãƒ³ãƒˆ**ã‚’ä»˜ä¸ã™ã‚‹ã¤ã‚‚ã‚Š](https://www.nhk.or.jp/politics/articles/lastweek/85263.html)ã‚‰ã—ã„ã€‚ãŠã¾ã‘ã«ã€[è³‡æºé«˜ã§é›»æ°—ä»£ã‚‚ã‚ãŒã‚Šã¾ã™ã€‚](https://www3.nhk.or.jp/news/html/20220629/k10013694641000.html)

ãŠè²¡å¸ƒã®ãŸã‚ã€éš£å®¶ã®ãŸã‚ã€ãŠå›½ã®ãŸã‚ã€åœ°çƒã®ãŸã‚ã€ç¯€é›»ã®ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–ã¯é«˜ã¾ã‚‹ä¸€æ–¹ã§ã™ã€‚ã‚ã‚ã€ãªã‚“ã ã‹ç¯€é›»ã—ãŸããªã£ã¦ããŸã€‚ã›ã£ã‹ããªã‚‰ç¯€é›»ã‚’æ¥½ã—ã¿ãŸã„...

ã¨ç„¡é§„ãªå‰ç½®ãã¯ã“ã‚Œãã‚‰ã„ã«ã—ã¦ã€ç†±ä¸­ç—‡ã«æ°—ã‚’ä»˜ã‘ã¤ã¤ã€Œ**ã‚¹ãƒãƒ¼ãƒˆç¯€é›»**ã€ã‚’ã—ã¦ã¿ã‚ˆã†ã€ã¨ã„ã†å¤§ç¾©ååˆ†ã«ã‹ã“ã¤ã‘ã¦ã€SwitchBotã§éŠã‚“ã§ã¿ã‚ˆã†ã€ã¨ã„ã†ã®ãŒæœ¬ç¨¿ã§ã™ã€‚

[^1]:ã€Œã‚€ã‚ã‚“ã€ã¨æ›¸ãã¾ã—ãŸãŒã€ä¸–ã«ã€Œã‚€ã‚ã‚“ã€ã¯ãªã„ã‚‚ã®ã§ã€å¤ªé™½å…‰ãƒ‘ãƒãƒ«ã‚’è‡ªå®…ã«è¨­ç½®ã™ã‚‹ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¨ãƒãƒ«ã‚®ãƒ¼ã«æŠ•è³‡ã™ã‚‹ã€åœ°çƒæ¸©æš–åŒ–å¯¾ç­–ãªã©ã€å€‹äººãƒ¬ãƒ™ãƒ«ã§ã‚‚ä¸­é•·æœŸçš„ã«ã¯è«–ãšã¹ãã“ã¨ãŒã‚ã‚‹ã®ã¯ã€è«–ã‚’ä¿Ÿã¡ã¾ã›ã‚“ã€‚

## ã‚„ã‚‹ã“ã¨
æ±äº¬é›»åŠ›ã®é›»åŠ›çŠ¶æ³ï¼ˆ**äºˆå‚™ç‡**ï¼‰ãŒã‚ã‚‹é–¾å€¤ã‚’è¶ŠãˆãŸã‚‰ã€ã‚¨ã‚¢ã‚³ãƒ³ã®æ¸©åº¦ï¼ˆã¨ç…§æ˜ï¼‰ã‚’èª¿æ•´ã™ã‚‹ã€‚
å…·ä½“çš„ã«ã¯ã‚¨ã‚¢ã‚³ãƒ³ã®æ¸©åº¦ã‚’ä¸Šã’ã€ç…§æ˜ã®ç…§åº¦ï¼ˆã¨è‰²ï¼‰ã‚’å¤‰ãˆã‚‹ã€‚

## ä½¿ã†ã‚‚ã®
- ã‚¨ã‚¢ã‚³ãƒ³ï¼ˆ1å°ï¼‰
- ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ï¼ˆSwitchBotã‚¢ãƒ—ãƒªï¼‰
- Google Apps Script
- [æ±äº¬é›»åŠ›é›»åŠ›ä¾›çµ¦çŠ¶æ³API](http://tepco-usage-api.appspot.com/)
  - ãã®åã®é€šã‚Šæ±äº¬é›»åŠ›ã®é›»åŠ›ä¾›çµ¦çŠ¶æ³ã‚’è¿”ã™APIã€‚å¤ã„ã€‚
- SwitchBot
  - [ãƒãƒ–ãƒŸãƒ‹](https://www.switchbot.jp/products/switchbot-hub-mini)
    - èµ¤å¤–ç·šãƒªãƒ¢ã‚³ãƒ³ã‚’é›†ç´„ã™ã‚‹ã€æ–‡å­—é€šã‚Šhubã«ãªã‚‹ã‚‚ã®ã€‚ã“ã‚Œã‚’ä»‹ã—ã¦ã‚¨ã‚¢ã‚³ãƒ³ã‚’åˆ¶å¾¡ã€‚
  - [æ¸©æ¹¿åº¦è¨ˆ](https://www.switchbot.jp/products/switchbot-meter) (optional) 
    - ç¯€é›»ã—ã™ãã¦ç†±ä¸­ç—‡ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã²ã¨æ‰‹é–“åŠ ãˆãŸã„å ´åˆã«ä½¿ã„ã¾ã™ã€‚
  - [ã‚¹ãƒãƒ¼ãƒˆé›»çƒ](https://www.switchbot.jp/products/switchbot-color-blub)(optional)
    -  ã€Œé›»åŠ›éœ€çµ¦ã²ã£è¿«æ³¨æ„å ±ã€ã‚’è¦–è¦šåŒ–ã™ã‚‹ãŸã‚ã«ä½¿ã„ã¾ã™ã€‚ãªãã¦ã‚‚ã‚ˆã„ã§ã™ã€‚

## ç”¨èª
æœ¬ç¨¿ã§å‡ºã¦ãã‚‹ç”¨èªã‚’ãŠã•ã‚‰ã„ã—ã¾ã™ã€‚

### SwitchBot
ã‚¹ãƒãƒ¼ãƒˆãƒ›ãƒ¼ãƒ ç”¨ã®æ§˜ã€…ãªå•†å“ã‚’ãŠæ‰‹é ƒä¾¡æ ¼ã§æä¾›ã—ã¦ã„ã‚‹ã€BtoCãƒ¡ã‚¤ãƒ³ã®IoTãƒ–ãƒ©ãƒ³ãƒ‰ã€‚
ã€Œæ—¥æœ¬ã§ã®åˆ©ç”¨è€…æ•°100ä¸‡ä¸–å¸¯çªç ´ã—ãŸã‚¹ãƒãƒ¼ãƒˆãƒ›ãƒ¼ãƒ ãƒ–ãƒ©ãƒ³ãƒ‰ã€ã¨[Twitterã®æ—¥æœ¬èªã‚¢ã‚«ã‚¦ãƒ³ãƒˆ](https://twitter.com/SwitchBotJapan)ã®bioæ¬„ã«æ›¸ã„ã¦ã‚ã‚Šã¾ã—ãŸã€‚éš™ã‚ã‚‰ã°çµµæ–‡å­—ã‚’å…¥ã‚Œã¦ãã‚‹ä¸­ã®äººãŒãƒ†ãƒ³ã‚·ãƒ§ãƒ³é«˜ã‚ç³»ä¼æ¥­ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã™ã€‚
2016å¹´ã€ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ•ã‚¡ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®[kickstarter](https://www.kickstarter.com/projects/switchbot/switch-bot-the-worlds-smallest-remote-robot/description)ç™ºã€‚é–‹ç™ºè€…ã®WonderTechLabã«ã¤ã„ã¦ã¯ã‚ã¾ã‚Šæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ã‚¶ã‚¤ãƒ³ãŒç™½ãã¦ä¸¸ã„ã®ã§æ°—ã«å…¥ã£ã¦ã„ã¾ã™ã€‚

ãªãŠã€æœ¬ç¨¿ã¯SwitchBotã€SwitchBotã¨é€£å‘¼ã—ã¾ã™ãŒã€å›ã—è€…ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ãƒãƒ¼ãƒˆãƒ›ãƒ¼ãƒ ç”¨è£½å“ã§ã¯ã€[Nature Remo](https://nature.global/nature-remo/nature-remo-mini/)ã‚‚è‰¯ã•ãã†ã§ã™ã€‚

### æ±äº¬é›»åŠ›ç®¡å†…
æ±äº¬éƒ½ã€ç¥å¥ˆå·çœŒã€åŸ¼ç‰çœŒã€åƒè‘‰çœŒã€æ ƒæœ¨çœŒã€ç¾¤é¦¬çœŒã€èŒ¨åŸçœŒã€å±±æ¢¨çœŒã€é™å²¡çœŒï¼ˆå¯Œå£«å·ä»¥æ±ï¼‰ï¼ˆ[å‡ºå…¸](https://tepco.zendesk.com/hc/ja/articles/360046063993)ï¼‰
ï¼Šå¯Œå£«å·ä»¥æ±ãªã‚“ã§ã™ã­ã€‚ãƒ†ã‚¹ãƒˆã«å‡ºãã†ã§ã™ã€‚

### é›»åŠ›éœ€çµ¦ã²ã£è¿«æ³¨æ„å ±
2022å¹´6æœˆ27æ—¥ã«åˆã‚ã¦ç™ºä»¤ã€‚äºˆå‚™ç‡5ï¼…ä¸‹å›ã‚‹ã¨äºˆæƒ³ã•ã‚Œã‚‹å ´åˆã«ç™ºä»¤ã•ã‚Œã‚‹ã€‚
ã€Œ**é›»åŠ›éœ€çµ¦ã²ã£è¿«è­¦å ±**ã€ã¯äºˆå‚™ç‡3ï¼…ä¸‹å›ã‚‹ã¨äºˆæƒ³ã•ã‚Œã‚‹å ´åˆã€‚

å‚è€ƒï¼šNHKã€Œ[åˆã®ã€Œé›»åŠ›éœ€çµ¦ã²ã£è¿«æ³¨æ„å ±ã€ è­¦å ±ã¨ã®é•ã„ ã™ãä½¿ãˆã‚‹ç¯€é›»æ–¹æ³•ã€](https://www.nhk.or.jp/shutoken/newsup/20220627a.html)ã€ï¼ˆ2022/06/27ï¼‰

### äºˆå‚™ç‡
ä¾›çµ¦åŠ›ï¼ˆcapacityï¼‰ã‹ã‚‰é›»åŠ›éœ€è¦ã‚’å¼•ã„ãŸå€¤ã‚’ "**äºˆå‚™åŠ›**"ã¨ã„ã„ã€ãã‚Œã‚’**é›»åŠ›éœ€è¦**ã§å‰²ã£ãŸãƒ¬ã‚·ã‚ªã€‚

$$
äºˆå‚™ç‡=\frac{äºˆå‚™åŠ› [ä¾›çµ¦åŠ›ï¼é›»æ°—ã®ä½¿ç”¨é‡(é›»åŠ›éœ€è¦)]
}{é›»æ°—ã®ä½¿ç”¨é‡(é›»åŠ›éœ€è¦)
}\times 100
$$

ä½¿ç”¨ç‡ã¯ã“ã¡ã‚‰ã€‚

$$
ä½¿ç”¨ç‡=\frac{é›»æ°—ã®ä½¿ç”¨é‡(é›»åŠ›éœ€è¦)}{ä¾›çµ¦åŠ›}\times 100
$$

åˆ†æ¯ãŒç•°ãªã‚‹ã®ã§ã€ä½¿ç”¨ç‡ã¨äºˆå‚™ç‡ã‚’è¶³ã—ã¦ã‚‚100%ã«ã¯ãªã‚‰ãªã„ã®ã§ã™ã­ã€‚**é›»åŠ›éœ€è¦**ãŒåˆ†æ¯ã¨ã„ã†ã®ãŒãƒã‚¤ãƒ³ãƒˆã€‚

ï¼ˆè³‡æ–™ï¼š[æ±äº¬é›»åŠ›ï¼šï¼œå‚è€ƒè³‡æ–™ï¼ä½¿ç”¨ç‡ã¨äºˆå‚™ç‡ã®è¨ˆç®—æ–¹æ³•ï¼ˆpdfï¼‰](https://www.tepco.co.jp/forecast/images/20220629.pdf)ï¼‰

äºˆæ¸¬é›»åŠ›ä½¿ç”¨é‡ã¯[ã“ã¡ã‚‰](https://www.tepco.co.jp/forecast/)ã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚é›»åŠ›ä½¿ç”¨ã®ãƒ”ãƒ¼ã‚¯ã¯15æ™‚ï½20æ™‚ã®æ™‚é–“å¸¯ã€å®‰å®šä¾›çµ¦ã«æœ€ä½é™å¿…è¦ãªäºˆå‚™ç‡ã¯3ï¼…ã€‚

## ä»Šå›ã®ç¯€é›»æ–¹æ³•ã«ã¤ã„ã¦
ä»Šå›ã¯ã‚¨ã‚¢ã‚³ãƒ³ã¯ã¤ã‘ã£ã±ãªã—ã«ã—ã€æ¸©åº¦ã‚’èª¿æ•´ã™ã‚‹ã“ã¨ã§ç¯€é›»ã—ã¾ã™ã€‚ã“ã¾ã‚ã«æ¶ˆã—ãŸã‚Šä»˜ã‘ãŸã‚Šã™ã‚‹æ–¹ãŒç¯€é›»åŠ¹æœãŒé«˜ã„ã®ã‹ã©ã†ã‹ã€ãƒ›ãƒƒãƒˆãªè­°è«–ãŒã‚ã‚Šã¾ã™ãŒã€ãƒ›ãƒƒãƒˆãªã®ã¯æ°—å€™ã ã‘ã§ååˆ†ãªã®ã§ã€åœ¨å®…æ™‚é–“ãŒé•·ã„ã¨ã„ã†å˜ç´”ãªæ±ºã‚æ‰‹ã§æ¸©åº¦èª¿æ•´æ´¾ã‚’æ¡ã‚Šã¾ã—ãŸã€‚

å®Ÿéš›ã®é›»åŠ›ä½¿ç”¨é‡ã®æ¨ç§»ã‚’ç¤ºã•ãªã„ã¨ç”»ç«œç‚¹ç›ã‚’æ¬ ãã®ã§ã™ãŒã€æœ¬ç¨¿ã§ã¯ã—ã¾ã›ã‚“ã€‚ç†ç”±ã¯é¢å€’ãã•ã„ã‹ã‚‰ã§ã™ã€‚å‰ææ¡ä»¶ã®é–‹ç¤ºãªã©â€¦

ã¶ã£ã¡ã‚ƒã‘ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‘ã°ã©ã†ã„ã†æ¡ä»¶ã§ã‚‚å®Ÿç¾ã§ãã‚‹ã®ã§ã€æœ€å¼·ã®ç¯€é›»æ–¹æ³•ã«ã¤ã„ã¦ã¯èª­è€…è«¸è³¢ã®ã”è¦‹è­˜ã¨é–“å–ã‚Šã¨åœ¨å®…æ™‚é–“ã¨ã‚¨ã‚¢ã‚³ãƒ³ã®æ©Ÿç¨®ã«å§”ã­ã‚‹æ‰€å­˜ã§ã‚ã‚Šã¾ã™ã€‚ã„ãšã‚Œã«ã›ã‚ˆã€ç¯€é›»ã«ã‚ˆã‚‹SwitchBotã®åŸä¾¡å›åã¯ä¸å¯ã§ã‚ã‚Šã¾ã—ã‚‡ã†ã€‚

## æœ¬é¡Œ
ã„ã‚ˆã„ã‚ˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚

### æ±äº¬é›»åŠ›é›»åŠ›ä¾›çµ¦çŠ¶æ³APIã‹ã‚‰äºˆå‚™ç‡ã‚’è¨ˆç®—ã™ã‚‹
[æ±äº¬é›»åŠ›é›»åŠ›ä¾›çµ¦çŠ¶æ³API](http://tepco-usage-api.appspot.com/)ã®ãƒšãƒ¼ã‚¸ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã†ã¡ã€
`http://tepco-usage-api.appspot.com/quick.txt`
ã‚’ä½¿ã„ã¾ã™ã€‚ä¸‹è¨˜ã¯ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã™ã€‚

```txt
7:30,3787,5824
```
å·¦ã‹ã‚‰`æ™‚åˆ»,ä½¿ç”¨é‡,ä¾›çµ¦é‡`ã€‚
2011å¹´ã®APIã§ãƒ¡ãƒ³ãƒ†çŠ¶æ³ãŒæ€ªã—ã„ã®ã§ã™ãŒã€æ±é›»ã®[é›»åŠ›ä½¿ç”¨çŠ¶æ³ãƒ‡ãƒ¼ã‚¿](https://www.tepco.co.jp/forecast/html/juyo-j.html)ã¨æ ¡åˆã—ãŸã¨ã“ã‚ã€å•é¡Œã¯ãªã•ãã†ã§ã™ã€‚

ã“ã“ã§äºˆå‚™ç‡ã®å¼ã‚’å†æ²ã—ã¾ã™ã€‚

$$
äºˆå‚™ç‡=\frac{äºˆå‚™åŠ› [ä¾›çµ¦åŠ›ï¼é›»æ°—ã®ä½¿ç”¨é‡(é›»åŠ›éœ€è¦)]
}{é›»æ°—ã®ä½¿ç”¨é‡(é›»åŠ›éœ€è¦)
}\times 100
$$

Google Apps Scriptã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€ã“ã‚Œã‚’ãã®ã¾ã¾æ¬¡ã®é–¢æ•°ã«ã—ã¾ã™ã€‚

```js:getTepcoReserveRate
/**
 * @return {number} æ±äº¬é›»åŠ›ç®¡å†…ã®é›»åŠ›äºˆå‚™ç‡
 */

function getTepcoReserveRate() {
  const tepco_endpoint = 'https://tepco-usage-api.appspot.com/quick.txt'
  const tepco_response = UrlFetchApp.fetch(tepco_endpoint).getContentText().split(",")
  const tepco_usage = tepco_response[1]
  const tepco_capacity = tepco_response[2]
  //äºˆå‚™ç‡ã¯å°æ•°ç‚¹ç¬¬1ä½ã¾ã§æœ‰åŠ¹ã€‚
  const reserve_rate = ((tepco_capacity - tepco_usage) / tepco_usage)*100
  const reserve_rate_rounded = Math.round(reserve_rate*10)/10
  console.info(`é›»åŠ›äºˆå‚™ç‡ï¼š${reserve_rate_rounded}ï¼ˆ${Utilities.formatDate(new Date(), "JST", "yyyy-MM-dd'T'HH:mm:ss'Z'")}ï¼‰`)
  return reserve_rate_rounded
}
```
äºˆå‚™ç‡ã®å°æ•°ç‚¹ã¯ç¬¬2ä½ã§ç¹°ã‚Šä¸Šã’ã§ã™ã€‚

### SwitchBot APIã®æº–å‚™
SwitchBotã«ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªAPIãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://github.com/OpenWonderLabs/SwitchBotAPI

æ‰‹å§‹ã‚ã«ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã«SwitchBotã®ã‚¢ãƒ—ãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
- [Android](https://play.google.com/store/apps/details?id=com.theswitchbot.switchbot&hl=ja&gl=US)
- [iOS](https://apps.apple.com/jp/app/switchbot/id1087374760)

ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã€ã‚¢ãƒ—ãƒªä¸Šã§ãƒãƒ–ãƒŸãƒ‹ã«ã‚¨ã‚¢ã‚³ãƒ³ã®ãƒªãƒ¢ã‚³ãƒ³ã‚’ç™»éŒ²ã—ã€ã‚¹ãƒãƒ¼ãƒˆé›»çƒã€æ¸©æ¹¿åº¦è¨ˆã‚‚ã‚ã‚ã›ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚ï¼ˆã“ã®è¾ºã‚Šã®æ‰‹é †ã¯ã‚¢ãƒ—ãƒªä¸Šã§ç›´æ„Ÿçš„ã«ã‚ã‹ã‚Šã‚„ã™ãã§ãã¦ã„ã‚‹ã®ã§å‰²æ„›ã—ã¾ã™ã€‚ï¼‰

ç¶šã„ã¦**APIèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³**ã‚’ç™ºè¡Œã—ã¾ã™ã€‚
èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚¢ãƒ—ãƒªã®è¨­å®šã‹ã‚‰ã€**ã€Œã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€ã‚’10å›ã‚¿ãƒƒãƒ—**ã™ã‚‹ã¨å‡ºç¾ã™ã‚‹**é–‹ç™ºè€…å‘ã‘ã‚ªãƒ—ã‚·ãƒ§ãƒ³**ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚
|![SwitchBot_token_1](https://storage.googleapis.com/zenn-user-upload/72a25d140e40-20220701.jpg)|![SwoitchBot_token_2](https://storage.googleapis.com/zenn-user-upload/8b2b8fa068d8-20220701.png)|
|:-:|:-:|
| ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼è¨­å®š  | ã€Œã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€ã‚’10å›ã‚¿ãƒƒãƒ— |

è£æŠ€ã¿ãŸã„ã§ãƒ¯ã‚¯ãƒ¯ã‚¯ã—ã¾ã™ã€‚

å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã¯Google Apps Scriptã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«`Switch_Bot_Token`ã‚’ã‚­ãƒ¼ã«ç™»éŒ²ã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/cbf18c51d13d-20220701.png =400x)


ãƒˆãƒ¼ã‚¯ãƒ³ã¯æ¼å‡ºã™ã‚‹ã¨å®¶ã‚’ä¹—ã£å–ã‚‰ã‚Œã¾ã™ã€‚

### SwitchBotãŸã¡ã‚’å–å¾—ã™ã‚‹ï¼ˆ/v1.0/devicesï¼‰
SwitchBot APIã§SwitchBotã®æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚
`/v1.0/devices`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¾ã™ã€‚

```json:/v1.0/devicesã®sample response
{
    "statusCode": 100,
    "body": {
        "deviceList": [
            {
                "deviceId": "500291B269BE",
                "deviceName": "Living Room Humidifier",
                "deviceType": "Humidifier",
                "enableCloudService": true,
                "hubDeviceId": "000000000000"
            }
        ],
        "infraredRemoteList": [
            {
                "deviceId": "02-202008110034-13",
                "deviceName": "Living Room TV",
                "remoteType": "TV",
                "hubDeviceId": "FA7310762361"
            }
        ]
    },
    "message": "success"
}
```
([APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/OpenWonderLabs/SwitchBotAPI)ã‚ˆã‚Š)

Switchbotãƒãƒ–ãƒŸãƒ‹ã§é€£æºã—ã¦ã„ã‚‹æ©Ÿå™¨ã€ä»Šå›ã®å ´åˆã¯ã‚¨ã‚¢ã‚³ãƒ³ã¯`infraredRemoteList`ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å†…ã«é…åˆ—ã¨ã—ã¦è¿”ã•ã‚Œã¾ã™ã€‚
ä¸€æ–¹ã€æ¸©æ¹¿åº¦è¨ˆã‚„ã‚¹ãƒãƒ¼ãƒˆé›»çƒã¯`deviceList`ã«å…¥ã‚Šã¾ã™ã€‚`deviceId`ã€`deviceName`ã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯å€¤ã§ã€`deviceName`ã¯ã‚¢ãƒ—ãƒªä¸Šã§è¨­å®šã—ãŸæ©Ÿå™¨ã®åç§°ã«ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã‚’è¸ã¾ãˆã€`target_device_names`ã§æŒ‡å®šã—ãŸ`deviceName`ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã®é…åˆ—ã‚’è¿”ã™é–¢æ•°ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã—ã¾ã—ãŸã€‚`'Authorization'`ãƒ˜ãƒƒãƒ€ã«å…ˆã»ã©ç™»éŒ²ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¸¡ã—ã¾ã™ã€‚

```js:getSwitchbotDevices
function getSwitchbotDevices() {
  //ã‚³ãƒãƒ³ãƒ‰ã‚’é€ã‚‹Switchbotã‚¢ãƒ—ãƒªã®ç™»éŒ²åï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰ã‚’æŒ‡å®šã€‚
  const target_device_names = ["ã‚¨ã‚¢ã‚³ãƒ³", "ã‚¹ãƒãƒ¼ãƒˆé›»çƒ 7406"]
  try {
    const devices = UrlFetchApp.fetch('https://api.switch-bot.com/v1.0/devices',
      {
        headers: {
          'Authorization': PropertiesService.getScriptProperties().getProperty('Switch_Bot_Token'),
          'Content-Type': `application/json; charset=utf8`
        }
      })
    console.log(`GET /v1.0/devices:${devices}`)

    //SwitchBot Hubã§é€£æºã—ã¦ã„ã‚‹Virtual infrared remote devicesã®é…åˆ—
    const devices_data = JSON.parse(devices).body
    const device_list = devices_data.deviceList
    const infrared_remote_list = devices_data.infraredRemoteList
    device_list.push(...infrared_remote_list)
    const target_devices = device_list.filter((device) => target_device_names.includes(device.deviceName))
    return target_devices
  }
  catch (e) {
    console.error(`GET /v1.0/devices Failed/${e}`)
    return
  }
}
```

#### æ¸©æ¹¿åº¦è¨ˆã§å®¤æ¸©ã‚’å–å¾—ã™ã‚‹ï¼ˆOptional, v1.0/devices/$deviceId/statusï¼‰
ã›ã£ã‹ããªã®ã§å®¤æ¸©ã‚’å–å¾—ã—ã¦ã¿ã¾ã™ã€‚

`meter_id`ã«å…ˆã»ã©å–å¾—ã—ãŸæ¸©æ¹¿åº¦è¨ˆã®`deviceId`ã‚’è¨˜å…¥ã—ã¾ã™ã€‚
ï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ã®ç®¡ç†ã®æ–¹ãŒè‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ï¼‰

```js:getRoomTemperature
function getRoomTemperature() {
  const meter_id = "<Your Meter deviceId>"
  const response = UrlFetchApp.fetch(`https://api.switch-bot.com/v1.0/devices/${meter_id}/status`,
    {
      headers: {
        'Authorization': PropertiesService.getScriptProperties().getProperty('Switch_Bot_Token'),
        'Content-Type': `application/json; charset=utf8`
      }
    })
  const room_temperature = JSON.parse(response).body.temperature
  if (room_temperature > 29) {
    console.warn(`å®¤æ¸©ï¼š${room_temperature}`)
  }
  else {
    console.log(`å®¤æ¸©ï¼š${room_temperature}`)
  }
  return room_temperature
}
```
ã“ã‚Œã§å®¤æ¸©ãŒå–å¾—ã§ãã¾ã™ã€‚29åº¦ã‚’è¶…ãˆãŸå ´åˆã¯ã€`console.warn`ã¨ã—ã¦ã€ãƒ­ã‚°ä¸Šã§ç›®ç«‹ãŸã›ã‚‹å°ç´°å·¥ã‚’æ–½ã—ã¾ã—ãŸã€‚

:::details å‚è€ƒï¼šæ¸©æ¹¿åº¦è¨ˆã®sample response

```json
{
    "statusCode": 100,
    "body": {
        "deviceId": "C271111EC0AB",
        "deviceType": "Meter",
        "hubDeviceId": "FA7310762361",
        "humidity": 52,
        "temperature": 26.1
    },
    "message": "success"
}
```
:::

#### ã‚¹ãƒãƒ¼ãƒˆé›»çƒã®é›»æºçŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ï¼ˆOptional, v1.0/devices/$deviceId/statusï¼‰
ã‚¹ãƒãƒ¼ãƒˆé›»çƒã®é›»æºãŒOnã«ãªã£ã¦ã„ã‚‹å ´åˆã®ã¿ã«ç…§åº¦ã‚’èª¿æ•´ã—ãŸã„ã®ã§ã€ã‚¹ãƒãƒ¼ãƒˆé›»çƒã®é›»æºçŠ¶æ…‹ã‚’å–å¾—ã—ã¦ã¿ã¾ã™ã€‚ã“ã‚Œã‚‚`v1.0/devices/$deviceId/status`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§å®Ÿç¾å¯èƒ½ã§ã™ã€‚

```js:isPowerOn
/**
 * @param {string} getSwitchbotDevices()ã§å–å¾—ã™ã‚‹deviceId
 * @return {boolean} é›»æºãŒä»˜ã„ã¦ã„ã‚Œã°Trueã€ãã†ã§ãªã‘ã‚Œã°False
 */

function isPowerOn(deviceId) {
  const device_state = UrlFetchApp.fetch(`https://api.switch-bot.com/v1.0/devices/${deviceId}/status`,
    {
      headers: {
        'Authorization': PropertiesService.getScriptProperties().getProperty('Switch_Bot_Token'),
        'Content-Type': `application/json; charset=utf8`
      }
    })
  const power_state = JSON.parse(device_state).body.power
  return power_state == "on" ? true : false
}
```
ãªãŠã€ãƒãƒ–ãƒŸãƒ‹çµŒç”±ã§ã‚¨ã‚¢ã‚³ãƒ³ãªã©ã®`Virtual infrared remote devices`ã®é›»æºã®On, Offæƒ…å ±ã¯å–å¾—ã§ããªã„ã‚ˆã†ã§ã™ã€‚ï¼ˆã”å­˜çŸ¥ã®æ–¹ã€ã”æ•™ç¤ºãã ã•ã„ã€‚ï¼‰

:::details å‚è€ƒï¼šã‚¹ãƒãƒ¼ãƒˆé›»çƒã®Sample Response

```json
{
    "statusCode": 100,
    "body": {
        "deviceId": "XXXXXX",
        "deviceType": "Color Bulb",
        "hubDeviceId": "6055F9287406",
        "power": "off",
        "brightness": 25,
        "color": "122: 80: 20",
        "colorTemperature": 0
    },
    "message": "success"
}
```
:::

### å®Ÿè£…ã™ã‚‹
ãƒ¡ã‚¤ãƒ³ã®é–¢æ•°ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚
å‡¦ç†ã®æµã‚Œã¯â†“
```mermaid
graph TD
A("ãƒˆãƒªã‚¬å®Ÿè¡Œ")-->|getTepcoReserveRate|B{"é›»åŠ›äºˆå‚™ç‡?"}
B-->|5%ä»¥ä¸‹|C(alert)-->F{"è­¦å ±ãƒ¬ãƒ™ãƒ«ã¯å¤‰åŒ–ã—ãŸï¼Ÿ"}
B-->|10%ä»¥ä¸‹|D(caution)-->F
B-->|ãã®ä»–|E(normal)-->F
F-->|No|Z("çµ‚äº†")
F-->|Yes|G[/æŒ‡å®šãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—\]
G-->|getSwitchbotDevices|H["ãƒ‡ãƒã‚¤ã‚¹ã®æ“ä½œ"]
H-->|controlSwitchbot|I[\å…¨ãƒ‡ãƒã‚¤ã‚¹ã‚’æ“ä½œã—ãŸã‚‰çµ‚äº†/]
```

### çŠ¶æ…‹ã¨è¨­å®šã®å®šç¾©
æœ€åˆã«çŠ¶æ…‹ã¨è¨­å®šã‚’æ±ºã‚ã¾ã™ã€‚

| çŠ¶æ…‹ | å®šç¾© |
|:-:|:-:|
| normal  | äºˆå‚™ç‡ãŒ10%ã‚ˆã‚Šå¤§ãã„  |
| caution  | äºˆå‚™ç‡ãŒ10%ä»¥ä¸‹ |
| alert  | äºˆå‚™ç‡ãŒ5%ä»¥ä¸‹  |

å…ˆè¿°ã®ã¨ãŠã‚Šã€Œé›»åŠ›éœ€çµ¦ã²ã£è¿«æ³¨æ„å ±ã€ã¯5%ã€ã€Œé›»åŠ›éœ€çµ¦ã²ã£è¿«è­¦å ±ã€ã¯3%ãŒé–¾å€¤ãªã®ã§ã€ãã‚Œã‚ˆã‚Šã¯é«˜ãè¨­å®šã—ã¦ã¿ã¾ã—ãŸã€‚

ãã‚Œãã‚Œã®çŠ¶æ…‹ã«å¯¾ã—ã¦ã‚¨ã‚¢ã‚³ãƒ³ã¨ç…§æ˜ã®è¨­å®šã‚’å®šç¾©ã—ã¾ã™ã€‚
ä¾‹ã¨ã—ã¦é€šå¸¸ã¯26â„ƒã€è­¦å ±ãƒ¬ãƒ™ãƒ«ã¨ã¨ã‚‚ã«1â„ƒãšã¤ä¸Šã’ã¦ã¿ã¾ã—ãŸã€‚
ç…§æ˜ã¯å¾ã€…ã«è½ã¨ã—ã¦ã„ãã€è‰²ã‚‚å¤‰ãˆã¦ã¿ã¾ã—ãŸã€‚
```js:saveWithSwitchbot / configsã®è¨­å®š
 //ã‚¨ã‚¢ã‚³ãƒ³ã®æ¸©åº¦ã¨ç…§æ˜ã®è¨­å®š
  const configs = {
    'normal': {
      'temperature': 26,
      'brightness': 100,
      'color': "255:255:255",
      'colorTemperature':2700	
    },
    'caution': {
      'temperature': 27,
      'brightness': 50,
      'color': "102:107:190",
      'colorTemperature':2700	
    },
    'alert': {
      'temperature': 28,
      'brightness': 25,
      'color': "122:80:20",
      'colorTemperature':2700
    }
  }
```
### äºˆå‚™ç‡ã«å¿œã˜ã¦çŠ¶æ…‹ã‚’æ±ºã‚ã‚‹
ç¶šã„ã¦å‰é …ã§å®šç¾©ã—ãŸé–¢æ•°ã§äºˆå‚™ç‡ã‚’å–å¾—ã€ãã‚Œã«å¿œã˜ã¦stateã‚’å®šç¾©ã—ã¾ã™ã€‚
æ¡ä»¶è©•ä¾¡ã®ã¨ã“ã‚ã§å…ˆã»ã©æ±ºã‚ãŸé–¾å€¤ã‚’ç”¨ã„ã¾ã™ã€‚

```js:saveWithSwitchbot / stateã®å®šç¾©
 //æ±äº¬é›»åŠ›ç®¡å†…ã®é›»åŠ›äºˆå‚™ç‡ã‚’å–å¾—
  const reserve_rate = getTepcoReserveRate()

  //é›»åŠ›äºˆå‚™ç‡ã«å¿œã˜ã¦çŠ¶æ…‹ã‚’å®šç¾©
  const state = () => {
    if (reserve_rate <= 5) {
      return 'alert'
    }
    else if (reserve_rate <= 10) {
      return 'caution'
    }
    else {
      return 'normal'
    }
  }

```
ã•ã‚‰ã«ã€çŠ¶æ…‹ãŒå¤‰åŒ–ã—ãŸå ´åˆã ã‘ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ãŸã„ã®ã§ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç”¨ã„ã¦ã€å‰å›å®Ÿè¡Œã®éš›ã®çŠ¶æ…‹ã¨æ¯”è¼ƒã—ã€å¤‰åŒ–ãŒãªã„å ´åˆã¯æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã•ã›ã¾ã™ã€‚
åˆå›ã¯normalã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¨­å®šã—ã¦ãŠãã¾ã™ã€‚

```js:saveWithSwitchbot / stateå¤‰åŒ–ã®æ¤œå‡º
 const current_state = state()
 console.log(current_state)
 const previous_state = PropertiesService.getScriptProperties().getProperty("STATE")
  if (current_state == previous_state) {
    //å‰å›å®Ÿè¡Œã‹ã‚‰Stateã®å¤‰æ›´ãŒãªã‘ã‚Œã°å®Ÿè¡Œã—ãªã„
    return "There is no change of state"
  }
  PropertiesService.getScriptProperties().setProperty('STATE', current_state)
```
### ãƒ‡ãƒã‚¤ã‚¹ã®å–å¾—
`getSwitchbotDevices()`ã§ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã‚’å–å¾—ã—ã€å„ãƒ‡ãƒã‚¤ã‚¹ã‚’æ“ä½œã—ã¾ã™ã€‚`controlSwitchbot(device, configs[current_state])`ã¯æ¬¡é …ã§å®šç¾©ã—ã¾ã™ã€‚

```js:saveWithSwitchbot / ãƒ‡ãƒã‚¤ã‚¹ã®å–å¾—
//Switchbotã®ãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—
  const switchbot_devices = getSwitchbotDevices()
  if (switchbot_devices.length > 0) {
    //å„ãƒ‡ãƒã‚¤ã‚¹ã”ã¨ã«ã‚³ãƒãƒ³ãƒ‰ã‚’é€ã‚‹ã€‚
    switchbot_devices.forEach(device => {
      controlSwitchbot(device, configs[current_state])
    })
  }
  else {
    console.error("No device found")
  }
```

### ãƒ‡ãƒã‚¤ã‚¹ã‚’æ“ä½œã™ã‚‹é–¢æ•°ã®ä½œæˆ
è¦ã¨ãªã‚‹ãƒ‡ãƒã‚¤ã‚¹ã®æ“ä½œé–¢æ•°ã‚’ä½œæˆã—ã¾ã™ã€‚

ã¾ãšpostã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã®é…åˆ—ã‚’ä½œæˆã—ã¾ã™ã€‚ã‚³ãƒãƒ³ãƒ‰ã¯[APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/OpenWonderLabs/SwitchBotAPI)ã«ã‚ã‚‹å½¢å¼ã§çµ„ã¿ç«‹ã¦ã¾ã™ã€‚
ãŸã¨ãˆã°ã‚¨ã‚¢ã‚³ãƒ³ã¯ã€
```json:ã‚¨ã‚¢ã‚³ãƒ³ã¸ã®ã‚³ãƒãƒ³ãƒ‰ã®ä¾‹
{
    "command": "setAll",
    "parameter": "26,1,3,on",
    "commandType": "command"
}
```
ã¨`setAll`ã‚’ä½¿ã„ã€`parameter`ã«`{temperature},{mode},{fan speed},{power state}`ã‚’è¨­å®šã—ã¾ã™ã€‚

ãƒ‡ãƒã‚¤ã‚¹ã®è­˜åˆ¥ã¯`deviceType`ã§ã—ã¦ã„ã¾ã™ãŒã€è¤‡æ•°æ©Ÿå™¨ã‚’ã‚ˆã‚Šç´°ã‹ãåˆ¶å¾¡ã—ãŸã‘ã‚Œã°ã€`deviceName`ã‚’ä½¿ãˆã‚‹ã§ã—ã‚‡ã†ã€‚

```js:controlSwitchbot / commandã®ä½œæˆ
/**
 * Switchbotã®æ“ä½œé–¢æ•°
 * @param device {object[]} ãƒ‡ãƒã‚¤ã‚¹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @param config {object} ãƒ‡ãƒã‚¤ã‚¹ã®è¨­å®šæƒ…å ±
 * API Document: https://github.com/OpenWonderLabs/SwitchBotAPI#command-set-for-virtual-infrared-remote-devices
 */

function controlSwitchbot(device, config) {
  const switchbot_domain = 'https://api.switch-bot.com'
  const switchbot_endpoint = `${switchbot_domain}/v1.0/devices/${device.deviceId}/commands`

  //deviceã®configæƒ…å ±ã‚’ã‚‚ã¨ã«ã€postã™ã‚‹commandã‚’ä½œæˆã€‚
  const commands = (device) => {
    if (device.deviceType == "Color Bulb" && isPowerOn(device.deviceId)) {
      return [{
        "command": "setBrightness",
        "parameter": config.brightness,
        "commandType": "command"
      },
      {
        "command": "setColor",
        "parameter": config.color,
        "commandType": "command"
      }]
    }
    //å®¤æ¸©ãŒ29â„ƒä»¥ä¸Šã®å ´åˆã¯ç†±ä¸­ç—‡é˜²æ­¢ã§26â„ƒè¨­å®šã€ãã‚Œä»¥ä¸Šã®å ´åˆã¯é›»åŠ›çŠ¶æ³ã«å¿œã˜ã¦è¨­å®šã€‚
    else if (device.remoteType == "Air Conditioner") {
      const temperature = getRoomTemperature() >= 29 ? 26 : config.temperature
      return [{
        "command": "setAll",
        "parameter": `${temperature},1,1,"on"`,
        "commandType": "command"
      }]
    }
    else{
      return [false]
    }
  }
```
ç†±ä¸­ç—‡å¯¾ç­–ã¨ã—ã¦ã€å…ˆã«å®šç¾©ã—ãŸ`getRoomTemperature()`ã‚’ä½¿ã„ã€å®¤æ¸©ãŒ29â„ƒã‚’è¶Šãˆã¦ã„ã‚‹å ´åˆã¯å¼·åˆ¶çš„ã«26â„ƒã«è¨­å®šã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚æ±äº¬é›»åŠ›ã•ã‚“ã€ã”ã‚ã‚“ãªã•ã„ã€‚

ç¶šã„ã¦é…åˆ—ã«ãªã£ã¦ã„ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’ä¸€ã¤ä¸€ã¤å®Ÿè¡Œã—ã¾ã™ã€‚
```js:controlSwitchbot / APIå®Ÿè¡Œ
  commands(device).forEach((command)=>{
  if (!command) {
    return console.log(`No Command Executed: ${device.deviceName}`)
  }

  const options = {
    headers: {
      'Authorization': PropertiesService.getScriptProperties().getProperty('Switch_Bot_Token'),
      'Content-Type': `application/json; charset=utf8`
    },
    payload: JSON.stringify(command)
  }
  try {
    const response = JSON.parse(UrlFetchApp.fetch(switchbot_endpoint, options))
    if (response.statusCode == 100) {
      console.log(`${device.deviceName}: ${options.payload}=>${JSON.stringify(response)}`)
    }
    else {
      console.error(`${device.deviceName}:${response}`)
    }
  }
  catch (e) {
    console.error(`Error Occurred while executing ${command}
    ErrorLog:${e}`)
  }
  })
}
```

ã“ã‚Œã§å®Œæˆã§ã™ã€‚æœ€å¾Œã«ã‚³ãƒ¼ãƒ‰ã®å…¨ä½“å›³ã‚’æŠ˜ã‚ŠãŸãŸã‚“ã§ç½®ã„ã¦ãŠãã¾ã™ã€‚

:::detailsã€€ã‚³ãƒ¼ãƒ‰ã®å…¨ä½“å›³

```js
function saveWithSwitchbot() {
  //ã‚¨ã‚¢ã‚³ãƒ³ã®æ¸©åº¦ã¨ç…§æ˜ã®è¨­å®š
  const configs = {
    'normal': {
      'temperature': 26,
      'brightness': 100,
      'color': "255:255:255",
      'colorTemperature':2700	
    },
    'caution': {
      'temperature': 27,
      'brightness': 50,
      'color': "102:107:190",
      'colorTemperature':2700	
    },
    'alert': {
      'temperature': 28,
      'brightness': 25,
      'color': "122:80:20",
      'colorTemperature':2700
    }
  }
  //æ±äº¬é›»åŠ›ç®¡å†…ã®é›»åŠ›äºˆå‚™ç‡ã‚’å–å¾—
  const reserve_rate = getTepcoReserveRate()

  //é›»åŠ›äºˆå‚™ç‡ã«å¿œã˜ã¦çŠ¶æ…‹ã‚’å®šç¾©
  const state = () => {
    if (reserve_rate <= 5) {
      return 'alert'
    }
    else if (reserve_rate <= 10) {
      return 'caution'
    }
    else {
      return 'normal'
    }
  }

  const current_state = state()
  console.log(current_state)
  const previous_state = PropertiesService.getScriptProperties().getProperty("STATE")
  if (current_state == previous_state) {
    //å‰å›å®Ÿè¡Œã‹ã‚‰Stateã®å¤‰æ›´ãŒãªã‘ã‚Œã°å®Ÿè¡Œã—ãªã„
    return "There is no change of state"
  }
  PropertiesService.getScriptProperties().setProperty('STATE', current_state)

  //Switchbotã®ãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—
  const switchbot_devices = getSwitchbotDevices()
  if (switchbot_devices.length > 0) {
    //å„ãƒ‡ãƒã‚¤ã‚¹ã”ã¨ã«ã‚³ãƒãƒ³ãƒ‰ã‚’é€ã‚‹ã€‚
    switchbot_devices.forEach(device => {
      controlSwitchbot(device, configs[current_state])
    })
  }
  else {
    console.error("No device found")
  }
}

/**
 * @return {number} æ±äº¬é›»åŠ›ç®¡å†…ã®é›»åŠ›äºˆå‚™ç‡
 */

function getTepcoReserveRate() {
  const tepco_endpoint = 'https://tepco-usage-api.appspot.com/quick.txt'
  const tepco_response = UrlFetchApp.fetch(tepco_endpoint).getContentText().split(",")
  const tepco_usage = tepco_response[1]
  const tepco_capacity = tepco_response[2]
  //äºˆå‚™ç‡ã¯å°æ•°ç‚¹ç¬¬1ä½ã¾ã§æœ‰åŠ¹ã€‚
  const reserve_rate = ((tepco_capacity - tepco_usage) / tepco_usage)*100
  const reserve_rate_rounded = Math.round(reserve_rate*10)/10
  console.info(`é›»åŠ›äºˆå‚™ç‡ï¼š${reserve_rate_rounded}ï¼ˆ${Utilities.formatDate(new Date(), "JST", "yyyy-MM-dd'T'HH:mm:ss'Z'")}ï¼‰`)
  return reserve_rate_rounded
}

/**
 * Switchbotã®æ“ä½œé–¢æ•°
 * @param device {object[]} ãƒ‡ãƒã‚¤ã‚¹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @param config {object} ãƒ‡ãƒã‚¤ã‚¹ã®è¨­å®šæƒ…å ±
 * API Document: https://github.com/OpenWonderLabs/SwitchBotAPI#command-set-for-virtual-infrared-remote-devices
 */

function controlSwitchbot(device, config) {
  const switchbot_domain = 'https://api.switch-bot.com'
  const switchbot_endpoint = `${switchbot_domain}/v1.0/devices/${device.deviceId}/commands`

  //deviceã®configæƒ…å ±ã‚’ã‚‚ã¨ã«ã€postã™ã‚‹commandã‚’ä½œæˆã€‚
  const commands = (device) => {
    if (device.deviceType == "Color Bulb" && isPowerOn(device.deviceId)) {
      return [{
        "command": "setBrightness",
        "parameter": config.brightness,
        "commandType": "command"
      },
      {
        "command": "setColor",
        "parameter": config.color,
        "commandType": "command"
      }]
    }
    //å®¤æ¸©ãŒ29â„ƒä»¥ä¸Šã®å ´åˆã¯ç†±ä¸­ç—‡é˜²æ­¢ã§26â„ƒè¨­å®šã€ãã‚Œä»¥ä¸Šã®å ´åˆã¯é›»åŠ›çŠ¶æ³ã«å¿œã˜ã¦è¨­å®šã€‚
    else if (device.remoteType == "Air Conditioner") {
      const temperature = getRoomTemperature() >= 29 ? 26 : config.temperature
      return [{
        "command": "setAll",
        "parameter": `${temperature},1,1,"on"`,
        "commandType": "command"
      }]
    }
    else{
      return [false]
    }
  }

  commands(device).forEach((command)=>{
  if (!command) {
    return console.log(`No Command Executed: ${device.deviceName}`)
  }

  const options = {
    headers: {
      'Authorization': PropertiesService.getScriptProperties().getProperty('Switch_Bot_Token'),
      'Content-Type': `application/json; charset=utf8`
    },
    payload: JSON.stringify(command)
  }
  try {
    const response = JSON.parse(UrlFetchApp.fetch(switchbot_endpoint, options))
    if (response.statusCode == 100) {
      console.log(`${device.deviceName}: ${options.payload}=>${JSON.stringify(response)}`)
    }
    else {
      console.error(`${device.deviceName}:${response}`)
    }
  }
  catch (e) {
    console.error(`Error Occurred while executing ${command}
    ErrorLog:${e}`)
  }
  })
}

/**
 * é…åˆ—ã§æŒ‡å®šã—ãŸãƒ‡ãƒã‚¤ã‚¹åã¨åˆè‡´ã™ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã®é…åˆ—ã‚’è¿”ã™
 * @return {object[]]	
 * [ { deviceId: '02-111111111-22222222',
    deviceName: 'é›»æ°—',
    remoteType: 'Light',
    hubDeviceId: 'AAAAAAAAAAA' },
  { deviceId: '02-333333333-44444444',
    deviceName: 'ã‚¨ã‚¢ã‚³ãƒ³',
    remoteType: 'Air Conditioner',
    hubDeviceId: 'XXXXXXXXXXX' } ]
 */

function getSwitchbotDevices() {
  //ã‚³ãƒãƒ³ãƒ‰ã‚’é€ã‚‹Switchbotã‚¢ãƒ—ãƒªã®ç™»éŒ²åï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰ã‚’æŒ‡å®šã€‚
  const target_device_names = ["ã‚¨ã‚¢ã‚³ãƒ³", "ã‚¹ãƒãƒ¼ãƒˆé›»çƒ 7406"]
  try {
    const devices = UrlFetchApp.fetch('https://api.switch-bot.com/v1.0/devices',
      {
        headers: {
          'Authorization': PropertiesService.getScriptProperties().getProperty('Switch_Bot_Token'),
          'Content-Type': `application/json; charset=utf8`
        }
      })
    console.log(`GET /v1.0/devices:${devices}`)

    //SwitchBot Hubã§é€£æºã—ã¦ã„ã‚‹Virtual infrared remote devicesã®é…åˆ—
    const devices_data = JSON.parse(devices).body
    const device_list = devices_data.deviceList
    const infrared_remote_list = devices_data.infraredRemoteList
    device_list.push(...infrared_remote_list)
    const target_devices = device_list.filter((device) => target_device_names.includes(device.deviceName))
    return target_devices
  }
  catch (e) {
    console.error(`GET /v1.0/devices Failed/${e}`)
    return
  }
}

/**
 * å®¤æ¸©ã‚’å–å¾—
 * sample response
 * {
    "statusCode": 100,
    "body": {
        "deviceId": "C271111EC0AB",
        "deviceType": "Meter",
        "hubDeviceId": "FA7310762361",
        "humidity": 52,
        "temperature": 26.1
    },
    "message": "success"
}
 */

function getRoomTemperature() {
  const meter_id = "<Your Meter deviceId>"
  const response = UrlFetchApp.fetch(`https://api.switch-bot.com/v1.0/devices/${meter_id}/status`,
    {
      headers: {
        'Authorization': PropertiesService.getScriptProperties().getProperty('Switch_Bot_Token'),
        'Content-Type': `application/json; charset=utf8`
      }
    })
  const room_temperature = JSON.parse(response).body.temperature
  if (room_temperature > 29) {
    console.warn(`å®¤æ¸©ï¼š${room_temperature}`)
  }
  else {
    console.log(`å®¤æ¸©ï¼š${room_temperature}`)
  }
  return room_temperature
}

/**
 * @param {string} getSwitchbotDevices()ã§å–å¾—ã™ã‚‹deviceId
 * @return {boolean} é›»æºãŒä»˜ã„ã¦ã„ã‚Œã°Trueã€ãã†ã§ãªã‘ã‚Œã°False
 */

function isPowerOn(deviceId) {
  const device_state = UrlFetchApp.fetch(`https://api.switch-bot.com/v1.0/devices/${deviceId}/status`,
    {
      headers: {
        'Authorization': PropertiesService.getScriptProperties().getProperty('Switch_Bot_Token'),
        'Content-Type': `application/json; charset=utf8`
      }
    })
 
  const power_state = JSON.parse(device_state).body.power
  return power_state == "on" ? true : false
}
```
:::

### ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒˆãƒªã‚¬ã®è¨­å®š
å‡ºæ¥ä¸ŠãŒã£ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®šæœŸå®Ÿè¡Œã•ã›ã‚‹ãŸã‚ã®ãƒˆãƒªã‚¬ã‚’è¨­å®šã—ã¾ã™ã€‚
Google Apps Scriptã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚ˆã‚Šç›®è¦šã¾ã—æ™‚è¨ˆã®ãƒãƒ¼ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã€è©¦ã¿ã«30åˆ†ãŠãã®å®Ÿè¡Œã§ãƒˆãƒªã‚¬è¨­å®šã—ã¾ã—ãŸã€‚
![](https://storage.googleapis.com/zenn-user-upload/52167b4f7f32-20220701.png)


#### å¤–å‡ºæ™‚ã«ã‚¨ã‚¢ã‚³ãƒ³ã‚’æ¶ˆã—ãŸã„å ´åˆã¯ãƒ»ãƒ»ãƒ»
ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å¤–å‡ºæ™‚ã«è­¦å ±ãƒ¬ãƒ™ãƒ«ãŒå¤‰ã‚ã‚‹ã¨ã€æ¶ˆã—ã¦ã„ãŸã‚¨ã‚¢ã‚³ãƒ³ã®é›»æºãŒOnã«ãªã‚‹æ¬ é™¥ãŒã‚ã‚Šã¾ã™ã€‚ã‚¨ã‚¢ã‚³ãƒ³ã®é›»æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ã§ãã‚Œã°ã‚ˆã„ã®ã§ã™ãŒã€ãƒãƒ–ãƒŸãƒ‹çµŒç”±ã®`Virtual infrared remote devices`ã¯å–å¾—ã§ããªã„ã‚ˆã†ã§ã™ã€‚
ã‚‚ã—å®Ÿè£…ã—ãŸã„ã®ã§ã‚ã‚Œã°ã€ã€Œ[SwitchBoté–‹é–‰ã‚»ãƒ³ã‚µãƒ¼](https://www.switchbot.jp/products/switchbot-contact-sensor)ã€ã‚’ä½¿ã£ãŸã‚Šã€å¤–å‡ºãƒ•ãƒ©ã‚°ã‚’Google Apps Scriptã«æ¸¡ã™ãªã‚Šã€å·¥å¤«ãŒå¿…è¦ã§ã™ã€‚

## ãŠã‚ã‚Šã«
æ±äº¬é›»åŠ›ã®é›»åŠ›ä¾›çµ¦ã®ã²ã£è¿«ã‚’æ¤œçŸ¥ã—ã€è‡ªå‹•ã§ç¯€é›»ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚
å®Ÿéš›ã®ç¯€é›»åŠ¹æœã¯ãªãŠæ¤œè¨¼ãŒå¿…è¦ã§ã™ãŒã€SwitchBotã®æ“ä½œã‚’ä¸€é€šã‚Šè§¦ã‚‹ã“ã¨ãŒã§ããŸã®ã§æœ¬ç¨¿ã¨ã—ã¦ã¯ååˆ†ã¨ã—ã¾ã™ã€‚æ¶ˆè²»é›»åŠ›ã®æ¤œè¨¼ã«ã¯[SwitchBotãƒ—ãƒ©ã‚°](https://www.switchbot.jp/products/switchbot-plug)ã‚‚ä½¿ãˆãã†ã§ã™ã€‚

å‰¯æ¬¡çš„ãªæ°—ã¥ãã§ã™ãŒã€ã‚ã‚‹æ¡ä»¶ã«ã‚ˆã£ã¦ç…§æ˜ãŒå¤‰ãˆã‚‰ã‚Œã‚‹ã“ã¨ã§ã€å„ç¨®è­¦å ±ã®è¦–è¦šçš„ãªã‚·ã‚°ãƒŠãƒ«ã«ãªã‚Šã€æ¡ˆå¤–åŠ¹æœçš„ã ã¨æ„Ÿã˜ã¾ã—ãŸã€‚

[å¤ã®ç¯€é›»ãƒãƒ£ãƒ¬ãƒ³ã‚¸2022](https://www.tepco.co.jp/ep/private/savingenergy/lp/challenge.html)ãªã©ç¯€é›»å‘¨ã‚Šã®å–ã‚Šçµ„ã¿ã‚‚æ´»æ€§åŒ–ã—ã¦ãã¦ã„ã‚‹ã®ã§ã€ã¿ãªã•ã‚“ã‚‚æ¥½ã—ã¿ãªãŒã‚‰ç¯€é›»ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

## å‚è€ƒæ–‡çŒ®ãƒ»ã‚µã‚¤ãƒˆ
### æ±äº¬é›»åŠ›
- [ï¼œå‚è€ƒè³‡æ–™ï¼ä½¿ç”¨ç‡ã¨äºˆå‚™ç‡ã®è¨ˆç®—æ–¹æ³•ï¼ˆpdfï¼‰](https://www.tepco.co.jp/forecast/images/20220629.pdf)ï¼‰

- [å¤ã®ç¯€é›»ãƒãƒ£ãƒ¬ãƒ³ã‚¸2022](https://www.tepco.co.jp/ep/private/savingenergy/lp/challenge.html)

### çµŒæ¸ˆç”£æ¥­çœ
- [é›»åŠ›éœ€çµ¦ã«é–¢ã™ã‚‹æ¤œè¨ä¼šåˆï¼ˆ2022/06/07ï¼‰](https://www.meti.go.jp/press/2022/06/20220607003/20220607003.html)

### NHK
- [ã€å‚åŠ æ–¹æ³•ã¯ï¼Ÿã€‘â€œç¯€é›»ã§ãƒã‚¤ãƒ³ãƒˆ2000å††ç›¸å½“â€ 8æœˆä¸­ã‚ã©ã«åˆ¶åº¦é–‹å§‹ã¸](https://www.nhk.or.jp/politics/articles/lastweek/85263.html)

- [ã“ã¨ã—8æœˆåˆ†ã®é›»æ°—æ–™é‡‘ å¤§æ‰‹é›»åŠ›10ç¤¾ã®ã†ã¡4ç¤¾ã§å€¤ä¸ŠãŒã‚Šã¸](https://www3.nhk.or.jp/news/html/20220629/k10013694641000.html)

- [åˆã®ã€Œé›»åŠ›éœ€çµ¦ã²ã£è¿«æ³¨æ„å ±ã€ è­¦å ±ã¨ã®é•ã„ ã™ãä½¿ãˆã‚‹ç¯€é›»æ–¹æ³•](https://www.nhk.or.jp/shutoken/newsup/20220627a.html)

### SwitchBoté–¢é€£
- [SwitchBotã‚’HubçµŒç”±ã§APIã‹ã‚‰æ“ä½œã™ã‚‹](https://qiita.com/itouuuuuuuuu/items/874cd992f473f30de45b)

### ãã®ä»–
#### console.xxx
- [JavaScriptã§ã®è³¢ã„console.log( )ã®ä½¿ã„æ–¹ & ãã®ä»–ä¾¿åˆ©ãªconsole.xxx( )ä½¿ã„æ–¹ã¾ã¨ã‚ (dirãƒ»tableãƒ»warnãƒ»groupã¨ã‹)](
https://qiita.com/mtoyopet/items/7274761af5424cee342a)
