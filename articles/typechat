---
title: TypeChatã‚’ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ç†è§£ã™ã‚‹
tags: typechat TypeScript OpenAI ChatGPT LLM
author: hosaka_
slide: false
---
# ã¯ã˜ã‚ã«
microsoftã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸ**TypeChat**ã€‚

https://microsoft.github.io/TypeChat/

ChatGPTã‚’æ‰±ã†ä¸Šã§ã¯ã€å›ç­”ãŒæ‰€å®šã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ãªã‚‹ã‚ˆã†ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒè‚ã«ãªã‚Šã¾ã™ã€‚ãã‚Œã‚’TypeScriptã®å‹ã‚·ã‚¹ãƒ†ãƒ ã§è¡ŒãŠã†ã€ã¨ã„ã†ã®ãŒTypeChatã«åº•æµã™ã‚‹ã‚¢ã‚¤ãƒ‡ã‚¢ã§ã™ã€‚

ã‚½ãƒ¼ã‚¹ã‚’ã¿ãŸã¨ã“ã‚ã€è¡Œæ•°ã‚‚å¤šããªãã€è‡ªåŠ›ã§è¿½ãˆã‚‹ç¯„å›²ã ã£ãŸã®ã§ã€å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ãŸã€‚

# TypeChatã®å¤§ã¾ã‹ãªæµã‚Œ
è¦‹é€šã—ã‚’è‰¯ãã™ã‚‹ãŸã‚ã«ã€æœ€åˆã«å‡¦ç†ã®æµã‚Œã‚’ç¤ºã—ã¦ãŠãã¾ã™ã€‚

TypeChatã¯JSONã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã«æ¬¡ã®æµã‚Œã§ã€`translate`ã‚’è¡Œã„ã¾ã™ã€‚

```mermaid
graph TD
	subgraph TypeChatJsonTranslator.translate
	    A[Natural Language] --complete--> B[Format in JSON]
	    B --TypeChatJsonValidator--> C[Validate JSON]
	end
    C --not valid--> D[Repair]
    D --repair complete--> C
    C --valid--> F[Answer]
```

è‡ªç„¶è¨€èªã‚’JSONã«ã™ã‚‹ã®ã¯ é–¢æ•°ã®Schemaã‚’ä¸ãˆã‚‹**Function calling**ã‚„**Zapier Natural Language Actions**ã¨é¡ä¼¼ã—ã¦ã„ã¾ã™ãŒã€å¤‰æ›ã—ãŸ**JSONã®ãƒã‚§ãƒƒã‚¯ã«TypeScriptã®å‹ãƒã‚§ãƒƒã‚¯ã‚’ç”¨ã„ã‚‹**ç‚¹ãŒã€TypeChatã®ç‰¹è‰²ã«ãªã‚Šã¾ã™ã€‚

---
**Function calling**

https://openai.com/blog/function-calling-and-other-api-updates

**Zapier Natural Language Actions**

https://zenn.dev/ptna/articles/cd0c10341713ae

---

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’çœºã‚ã‚‹
https://github.com/microsoft/TypeChat/tree/main/src

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
TypeChatã®æœ¬ä½“ã¯ä¸‹è¨˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãªã‚Šã¾ã™ã€‚
```
- src
  - index.ts
  - interactive.ts
  - model.ts
  - program.ts
  - result.ts
  - tsconfig.json
  - typechat.ts 
  - validate.ts
```

tsconfig.jsonã¯ã®ãã„ã¦ã€ã“ã‚Œã‚’æ„šç›´ã«ä¸Šã‹ã‚‰è¦‹ã¦ã„ãã¾ã™ã€‚


## index.ts
https://github.com/microsoft/TypeChat/blob/b380488c807f6676e88ccf3e9469b4e8f1b170b0/src/index.ts#L1-L6

ã“ã‚Œã¯æ–‡å­—é€šã‚Šã®ã€Œindexã€ã§ã€ç‰¹è¨˜ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆãŒå˜ä¸€ã«ãªã‚Šã€ãŸã¨ãˆã°ã€

```ts
import { createLanguageModel, createJsonTranslator, processRequests } from "typechat";
```

ã®ã‚ˆã†ã«`from "typechat"`ã§ã¾ã¨ã‚ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## interactive.ts
https://github.com/microsoft/TypeChat/blob/b380488c807f6676e88ccf3e9469b4e8f1b170b0/src/interactive.ts

```ts
export async function processRequests(interactivePrompt: string, inputFileName: string | undefined, processRequest: (request: string) => Promise<void>)
```

ã“ã‚Œã‚‚TypeChatã®æœ¬è³ªã«é–¢ä¿‚ã®ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«åãŒå¼•æ•°ã«ä¸ãˆã‚‰ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ãã†ã§ãªã„å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã‚’æ±‚ã‚ã€å…¥åŠ›ã®å„è¡Œã«å¯¾ã—ã¦callbackå‡¦ç†ã‚’è¡Œã†é–¢æ•°ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

callbackã«ã¯TypeChatã®å‡¦ç†ãŒå…¥ã‚Šã¾ã™ã€‚


### ä½¿ç”¨ä¾‹
```ts
// Process requests interactively or from the input file specified on the command line
processRequests("ğŸ˜€> ", process.argv[2], async (request) => {
    const response = await translator.translate(request);
    if (!response.success) {
        console.log(response.message);
        return;
    }
    console.log(`The sentiment is ${response.data.sentiment}`);
});
```
https://github.com/microsoft/TypeChat/blob/b380488c807f6676e88ccf3e9469b4e8f1b170b0/examples/sentiment/src/main.ts#L14-L22


## model.ts
OpenAIã¨Azure OpenAIã®encapsulationï¼ˆã‚«ãƒ—ã‚»ãƒ«åŒ–ï¼‰ã§ã‚ã‚‹`TypeChatLanguageModel`ã‚’ä½œæˆã™ã‚‹é–¢æ•°ç¾¤ã€‚

- createLanguageModel
  - createOpenAILanguageModel / createAzureOpenAILanguageModel
    - createAxiosLanguageModel
      - complete(prompt: string)


**TypeChatLanguageModel**
```ts
export interface TypeChatLanguageModel {
    retryMaxAttempts?: number;
    retryPauseMs?: number;
    complete(prompt: string): Promise<Result<string>>;
}
```
https://github.com/microsoft/TypeChat/blob/b380488c807f6676e88ccf3e9469b4e8f1b170b0/src/model.ts#L10C1-L25C1

**OPENAI_API_KEY**ã¨**OPENAI_MODEL**ãŒ`.env`ã«ã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€OpenAIã‚’ã€**AZURE_OPENAI_API_KEY**ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€Azure OpenAI Serviceã‚’ç”¨ã„ã¾ã™ã€‚

APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯`complete`ãƒ¡ã‚½ãƒƒãƒ‰ã§è¡Œã‚ã‚Œã¾ã™ã€‚

```ts
complete(prompt: string): Promise<Result<string>>;
```

### ä½¿ç”¨ä¾‹
`createJsonTranslator`ã®å¼•æ•°ã¨ã—ã¦ç”¨ã„ã¾ã™ã€‚
```ts
const model = createLanguageModel(process.env);
const translator = createJsonTranslator<SentimentResponse>(model, schema, "SentimentResponse");
```

https://github.com/microsoft/TypeChat/blob/b380488c807f6676e88ccf3e9469b4e8f1b170b0/examples/sentiment/src/main.ts#L12

## program.ts
ã“ã‚Œã¯æœ€å¾Œã«èª¬æ˜ã—ãŸæ–¹ãŒã‚ã‹ã‚Šã‚„ã™ã„ã®ã§ã€å¾Œå›ã—ã«ã—ã¾ã™ã€‚

## result.ts
å®Ÿè¡Œçµæœã¸ã®å‹ä»˜ã‘ã€‚ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç”¨ã€‚

- Success/Errorã¨ãã®ãƒ¦ãƒ‹ã‚ªãƒ³ã®Resultå‹ã‚’å®šç¾©
```ts
export type Success<T> = { success: true, data: T };
export type Error = { success: false, message: string };
export type Result<T> = Success<T> | Error;
```

- getDataé–¢æ•°: Successã®å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ã‚’ã€Errorã®å ´åˆã¯Errorã‚’æŠ•ã’ã‚‹ã€‚

https://github.com/microsoft/TypeChat/blob/e300dccd2fbf846518dba7fe94a36a30168885ec/src/result.ts

### ä½¿ç”¨ä¾‹
```ts
    console.log(getData(translator.validator.createModuleTextFromJson(program)));
```
https://github.com/microsoft/TypeChat/blob/b380488c807f6676e88ccf3e9469b4e8f1b170b0/examples/math/src/main.ts#L21

## typechat.ts
å…¨ä½“ã®ãƒ¡ã‚¤ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ã€‚å†’é ­ã®ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ã§ã‚‚ç¤ºã—ãŸ**TypeChatJsonTranslator**ã‚’å®šç¾©ã—ã¾ã™ã€‚

```typechat.ts
export interface TypeChatJsonTranslator<T extends object> {
    model: TypeChatLanguageModel;
    validator: TypeChatJsonValidator<T>;
    attemptRepair:  boolean;
    stripNulls:  boolean;
    createRequestPrompt(request: string): string;
    createRepairPrompt(validationError: string): string;
    translate(request: string): Promise<Result<T>>;
}
```

**TypeChatJsonTranslator**ã¯ã€`translate`ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã‚Šã€

- è‡ªç„¶è¨€èªã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’JSONã«å¤‰æ›
- å›ç­”ãŒJSONã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
- **TypeChatJsonValidator**ã«ã‚ˆã‚‹JSONã®å‹ãƒã‚§ãƒƒã‚¯
- ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸå ´åˆã¯ä¿®æ­£ï¼ˆrepair)

ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

### 1. è‡ªç„¶è¨€èªã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’JSONã«å¤‰æ›
LLMï¼ˆOpenAIï¼‰ã‚’ç”¨ã„ã¦å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯`createRequestPrompt`ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«å¤‰æ•°ã«å®šæ•°ã‚’å…¥ã‚Œã¦æ²ç¤ºã—ã¾ã™ã€‚

```txt
You are a service that translates user requests into JSON objects of type "SentimentResponse" according to the following TypeScript definitions:

    ```
    // The following is a schema definition for determining the sentiment of a some user input.
    interface SentimentResponse {
      sentiment: "negative" | "neutral" | "positive";  // The sentiment of the text
    }
    ```

    The following is a user request:
    ```
    TypeChat is awesome!
    ```
            
The following is the user request translated into a JSON object with 2 spaces of indentation and no properties with the value undefined:

```

*The following is...* ã§å§‹ã¾ã‚‹æœ€å¾Œä¸€æ–‡ã¯ã€LLMã‚’èª˜å°ã™ã‚‹ã€ã„ã‚ã‚†ã‚‹**leading words**ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

ã“ã‚Œã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã—ã¦ã€**TypeChatLanguageModel**ã®`complete`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

### 2. å›ç­”ãŒJSONã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
`{}`ã‚’è¦‹ã¦ã€JSONå½¢å¼ã‹ã©ã†ã‹ã‚’è¦‹ã¦ã€JSONæ–‡å­—åˆ—ã‚’æŠ½å‡ºã€‚
```ts
    const startIndex = responseText.indexOf("{");
    const endIndex = responseText.lastIndexOf("}");
    if (!(startIndex >= 0 && endIndex > startIndex)) {
        return error(`Response is not JSON:\n${responseText}`);
    }
    const jsonText = responseText.slice(startIndex, endIndex + 1);
```

### 3. **TypeChatJsonValidator**ã«ã‚ˆã‚‹JSONã®å‹ãƒã‚§ãƒƒã‚¯
```ts
    const validation = validator.validate(jsonText);
```
TypeChatã®æ ¸å¿ƒã§ã™ãŒã€ã“ã“ã®å‡¦ç†ã¯æ¬¡é …ã§è¦‹ã¦ã„ãã¾ã™ã€‚

### 4. ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸå ´åˆã¯ä¿®æ­£ï¼ˆrepair)
ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸå ´åˆã¯ã€ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’`createRepairPrompt`ã§ä½œæˆã—ã€å†ã³LLMã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã™ã€‚

```
${responseText}

The JSON object is invalid for the following reason:

"""
${validationError}
"""

The following is a revised JSON object:
```

## validate.ts
TypeChatã‚’ç‰¹å¾´ã¥ã‘ã‚‹ã€JSONã¨å‹Schemaã®ç…§åˆã‚’è¡Œã†**TypeChatJsonValidator**ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

```validate.ts
export interface TypeChatJsonValidator<T extends object> {
    schema: string;
    typeName: string;
    stripNulls:  boolean;
    createModuleTextFromJson(jsonObject: object): Result<string>;
    validate(jsonText: string): Result<T>;
}
```
https://github.com/microsoft/TypeChat/blob/b380488c807f6676e88ccf3e9469b4e8f1b170b0/src/validate.ts#L17C1-L48

ã“ã®ã†ã¡ã€**validate**ãŒé¢ç™½ã„ã“ã¨ã‚’ã‚„ã£ã¦ã„ã¾ã™ã€‚


### validate
```ts
    function validate(jsonText: string)
```

https://github.com/microsoft/TypeChat/blob/e300dccd2fbf846518dba7fe94a36a30168885ec/src/validate.ts#L75C1-L98

å¼•æ•°ã«ã¯LLMã‹ã‚‰è¿”ã£ã¦ããŸJSONï¼ˆ?ï¼‰ã®æ–‡å­—åˆ—ã‚’å–ã‚Šã¾ã™ã€‚

ä½•ã‚’validateã—ã¦ã„ã‚‹ã‹é †ã€…ã«è¦‹ã¦ã„ãã¾ã™ã€‚

#### 1. parseã§ãã‚‹ã‹
ã¾ãšparseã§ãã‚‹JSONã‹ã©ã†ã‹ã€‚æ™®é€šã«try...catchã€‚

```validate.ts
        try {
            jsonObject = JSON.parse(jsonText) as object;
        }
        catch (e) {
            return error(e instanceof SyntaxError ? e.message : "JSON parse error");
        }
```

#### 2. Nullãƒã‚§ãƒƒã‚¯ï¼ˆoptional)
`stripNulls`ãŒtrueã«ãªã£ã¦ã„ã‚‹å ´åˆã¯ã€å€¤ãŒnullã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å‰Šé™¤ã€‚

```validate.ts
        if (validator.stripNulls) {
            stripNulls(jsonObject);
        }
```


#### 3. createModuleTextFromJsonï¼šå‹Schemaã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ä½œæˆ
ã“ã“ã‹ã‚‰ãŒTypeChatã®è¦ç‚¹ã§ã™ã€‚å‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚ã«TypeScriptã‚’ä½œæˆã€ã¤ã¾ã‚Šãƒ¡ã‚¿ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã€‚

å¼•æ•°ã§ä¸ãˆã‚‰ã‚Œã‚‹`typeName`ã‹ã‚‰ã€TypeScriptã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ã‚’ä½œã‚Šã¾ã™ã€‚

```validate.ts
import { ${typeName} } from './schema';\nconst json: ${typeName} = ${JSON.stringify(jsonObject, undefined, 2)}
```

ãŸã¨ãˆã°ã€`SentimentResponse`ãŒtypeNameã¨ã—ã¦ä¸ãˆã‚‰ã‚Œã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªTypeScriptã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ æ–‡ã‚’è¿”ã—ã¾ã™ã€‚

```ts
import { SentimentResponse } from './schema';
const json: SentimentResponse = {
  "sentiment": "neutral"
};
```

#### 4. createProgramFromModuleText:TypeScriptã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ æ–‡ã‚’ä½œã‚‹
åŒæ§˜ã«ã—ã¦ã€å¼•æ•°ã®schemaã‚’ä½¿ã£ã¦ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰å‹ãƒã‚§ãƒƒã‚¯ç”¨ã®TypeScriptã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œã‚Šã¾ã™ã€‚

**createProgramFromModuleText**ã¯ã€ãŸã¨ãˆã°ä»¥ä¸‹ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œã‚Šã¾ã™ã€‚

```sample.ts
interface Array<T> { length: number, [n: number]: T }
interface Object { toString(): string }
interface Function { prototype: unknown }
interface CallableFunction extends Function {}
interface NewableFunction extends Function {}
interface String { readonly length: number }
interface Boolean { valueOf(): boolean }
interface Number { valueOf(): number }
interface RegExp { test(string: string): boolean }

// The following is a schema definition for determining the sentiment of a some user input.
interface SentimentResponse {
  sentiment: "negative" | "neutral" | "positive";  // The sentiment of the text
}

const json: SentimentResponse = {
  "sentiment": "neutral"
};
```

#### 5. TypeScriptã‚’compileã—ã¦å‹ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†
```validate.ts
        const syntacticDiagnostics = program.getSyntacticDiagnostics();
        const programDiagnostics = syntacticDiagnostics.length ? syntacticDiagnostics : program.getSemanticDiagnostics();
        if (programDiagnostics.length) {
            const diagnostics = programDiagnostics.map(d => typeof d.messageText === "string" ? d.messageText : d.messageText.messageText).join("\n");
            return error(diagnostics);
        }
```

ä½œæˆã—ãŸTypeScriptã«ä»¥ä¸‹ã®äºŒã¤ã®ãƒã‚§ãƒƒã‚¯ã‚’ã‹ã‘ã¾ã™ã€‚

- getSyntacticDiagnosticsï¼šã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ã®ãƒã‚§ãƒƒã‚¯
- getSemanticDiagnosticsï¼šæ„å‘³è§£æ

ã‚‚ã—ã‚‚å‹ãŒç•°ãªã£ãŸJSONãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã€JSONã®å‹ãƒã‚§ãƒƒã‚¯ãŒã§ãã‚‹ã€ã¨ã„ã†ä»•çµ„ã¿ã§ã™ã€‚

**å‚è€ƒè¨˜äº‹**
ï¼Š2013å¹´ã®å¤ã„è¨˜äº‹ã§ã™ã€‚

https://qiita.com/JunSuzukiJapan/items/708bc21fca88f6ee6f8b

### program.tsã€€
æœ€å¾Œã«å¾Œå›ã—ã«ã—ãŸ**program.ts**ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚

https://github.com/microsoft/TypeChat/blob/e300dccd2fbf846518dba7fe94a36a30168885ec/src/program.ts

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¡ã‚¤ãƒ³ã®é–¢æ•°ã¯`createProgramTranslator`ã§ã€é–¢æ•°å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ãªSchemaã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¸ãˆãŸç‰¹æ®Šãª`TypeChatJsonTranslator`ã‚’ä½œã‚‹ã®ãŒä¸»ãªå½¹å‰²ã§ã™ã€‚è¦ã™ã‚‹ã«ChatGPTã®Function callingçš„ãªã“ã¨ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

#### createProgramTranslator

```ts
export function createProgramTranslator(model: TypeChatLanguageModel, schema: string): TypeChatJsonTranslator<Program> {

    const translator = createJsonTranslator<Program>(model, schema, "Program");
    ...
```

ã“ã®schemaã¨**Program**å‹ãŒç‰¹æ®Šã§ã™ã€‚

##### Schema
å®Ÿè¡Œã™ã‚‹é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£ã‚’å®šç¾©ã—ã¾ã™ã€‚Schemaã¯"API"ã¨ã„ã†åå‰ã®å‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãŸã¨ãˆã°ã€*math*ã®ã‚µãƒ³ãƒ—ãƒ«ã¯ä¸‹è¨˜ã€‚

```mathSchema.ts
export type API = {
    // Add two numbers
    add(x: number, y: number): number;
    // Subtract two numbers
    sub(x: number, y: number): number;
    // Multiply two numbers
    mul(x: number, y: number): number;
    // Divide two numbers
    div(x: number, y: number): number;
    // Negate a number
    neg(x: number): number;
    // Identity function
    id(x: number): number;
    // Unknown request
    unknown(text: string): number;
}
```

https://github.com/microsoft/TypeChat/blob/b380488c807f6676e88ccf3e9469b4e8f1b170b0/examples/math/src/mathSchema.ts#L5

##### Programå‹
LLMã®è¿”ã‚Šå€¤ã‚’parseã—ã¦å®Ÿè¡Œã™ã‚‹ãŸã‚ã®å‹ã€‚

ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¸€éƒ¨çœãã¨ã€æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```program.ts
export type Program = {
    "@steps": FunctionCall[];
}

export type FunctionCall = {
    // Name of the function
    "@func": string;
    // Arguments for the function, if any
    "@args"?: Expression[];
};

export type Expression = JsonValue | FunctionCall | ResultReference;
export type JsonValue = string | number | boolean | null | { [x: string]: Expression } | Expression[];
export type ResultReference = {
    // Index of the previous expression in the "@steps" array
    "@ref": number;
};
```

https://github.com/microsoft/TypeChat/blob/b380488c807f6676e88ccf3e9469b4e8f1b170b0/src/program.ts#L36-L68

ãŸã¨ãˆã°ã€å…ˆã»ã©ã®Schemaã¨

>multiply two by three, then multiply four by five, then sum the results

ã‚’å…¥åŠ›ã—ãŸå ´åˆã€æ¬¡ã®ã‚ˆã†ãªProgramå‹ã®JSONãŒè¿”ã£ã¦ãã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¾ã™ã€‚
```ts
[ 
    {
        @func: 'mul', @args: [2,3]
    },
    {
        @func: 'mul', @args: [4,5]
    },
    {
        @func: 'add', @args: [ { @ref: 0 }, { @ref: 1 } ]
    }
]
```

##### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
é–¢æ•°å‘¼ã³å‡ºã—ã«é–¢ã™ã‚‹ç‚¹ãŒåŠ ãˆã‚‰ã‚Œã€å°‘ã—ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚Œã¦ã„ã¾ã™ã€‚

```
The programs can call functions from the API defined in the following TypeScript definitions: 
    ```
    ${translator.validator.schema}
    ``` 
```

#### createModuleTextFromProgram
å‹ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†å‰ã«ã€`createModuleTextFromJson`ã‚’ä½¿ã£ã¦ã€JSONãƒ‡ãƒ¼ã‚¿ã‚’TypeScriptã«ã—ã¾ã™ãŒã€ãã‚Œã‚’**Program**å‹ç”¨ã«ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã—ãŸã®ãŒã€`createModuleTextFromProgram`ã§ã™ã€‚

ãŸã¨ãˆã°ã€å…ˆã»ã©ã®ä¾‹ã®

```ts
[ 
    {
        @func: 'mul', @args: [2,3]
    },
    {
        @func: 'mul', @args: [4,5]
    },
    {
        @func: 'add', @args: [ { @ref: 0 }, { @ref: 1 } ]
    }
]
```

ã¯ã€

```ts
import { API } from "./schema";
function program(api: API) {
  const step1 = api.mul(2, 3);
  const step2 = api.mul(4, 5);
  return api.add(step1, step2);
}
```

ã«parseã•ã‚Œã€TypeScriptã®å‹ãƒã‚§ãƒƒã‚¯ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

Schemaã®å‹ã®åå‰ã‚’`API`ã¨ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã®ã¯ã€ä¸‹è¨˜ã§æŒ‡å®šã—ã¦ã„ã‚‹ãŸã‚ã§ã—ãŸã€‚

https://github.com/microsoft/TypeChat/blob/b380488c807f6676e88ccf3e9469b4e8f1b170b0/src/program.ts#L99

#### evaluateJsonProgram
ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œã¯ã€

```ts
    const result = await evaluateJsonProgram(program, handleCall);
```
ã®ã‚ˆã†ã«`evaluateJsonProgram`ã§è¡Œã„ã¾ã™ã€‚

ç¬¬ä¸€å¼•æ•°ã«ã¯**Program**å‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå…¥ã‚Šã€handleCallã«é–¢æ•°åã¨é–¢æ•°ã®å¼•æ•°ãŒæ¸¡ã‚‹ã®ã§ã€å®Ÿéš›ã®å‡¦ç†ã‚’æ›¸ãã¾ã™ã€‚Function Callingã¨åŒã˜ã§ã™ã€‚

ã“ã‚Œã¾ã§ã®`math`ã®ä¾‹ã ã¨ã€handleCallã¯æ¬¡ã®ã‚ˆã†ãªå®Ÿè£…ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚

```ts
async function handleCall(func: string, args: any[]): Promise<unknown> {
    console.log(`${func}(${args.map(arg => typeof arg === "number" ? arg : JSON.stringify(arg, undefined, 2)).join(", ")})`);
    switch (func) {
        case "add":
            return args[0] + args[1];
        case "sub":
            return args[0] - args[1];
        case "mul":
            return args[0] * args[1];
        case "div":
            return args[0] / args[1];
        case "neg":
            return -args[0];
        case "id":
            return args[0];
    }
    return NaN;
}
```

https://github.com/microsoft/TypeChat/blob/b380488c807f6676e88ccf3e9469b4e8f1b170b0/examples/math/src/main.ts#L27-L44

é–¢æ•°åã§switchã—ã¦é–¢æ•°å®Ÿè£…ã‚’è¿”ã™ã ã‘ã§ã™ã­ã€‚

---- 

## ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã¦ã¿ã‚‹
æŒ¯ã‚Šè¿”ã‚Šã‚‚å…¼ã­ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®ã†ã¡ã‹ã‚‰ã€`sentiment.ts`ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

```ts
import fs from "fs";
import path from "path";
import dotenv from "dotenv";
import { createLanguageModel, createJsonTranslator, processRequests } from "typechat";
import { SentimentResponse } from "./sentimentSchema";

// TODO: use local .env file.
dotenv.config({ path: path.join(__dirname, "../../../.env") });

const model = createLanguageModel(process.env);
const schema = fs.readFileSync(path.join(__dirname, "sentimentSchema.ts"), "utf8");
const translator = createJsonTranslator<SentimentResponse>(model, schema, "SentimentResponse");

// Process requests interactively or from the input file specified on the command line
processRequests("ğŸ˜€> ", process.argv[2], async (request) => {
    const response = await translator.translate(request);
    if (!response.success) {
        console.log(response.message);
        return;
    }
    console.log(`The sentiment is ${response.data.sentiment}`);
});
```
https://github.com/microsoft/TypeChat/blob/b380488c807f6676e88ccf3e9469b4e8f1b170b0/examples/sentiment/src/main.ts

### 1. TypeChatJsonTranslatorã®ä½œæˆ
```ts
dotenv.config({ path: path.join(__dirname, "../../../.env") });

const model = createLanguageModel(process.env);
const schema = fs.readFileSync(path.join(__dirname, "sentimentSchema.ts"), "utf8");
const translator = createJsonTranslator<SentimentResponse>(model, schema, "SentimentResponse");
```

ä¸Šã«è¦‹ãŸé€šã‚Šã€model, schemaï¼ˆå‹å®šç¾©ï¼‰ã‚’å¼•æ•°ã«æ¸¡ã—ã¦ã€TypeChatJsonTranslatorã‚’ä½œã‚Šã¾ã™ã€‚

### 2. å…¥åŠ›
æ¨™æº–å…¥åŠ›ã‹ã‚‰å€¤ã‚’å—ã‘å–ã‚Šã€`translate`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```ts
processRequests("ğŸ˜€> ", process.argv[2], async (request) => {
    const response = await translator.translate(request);
    ...
}
```

### 3. translateã®å®Ÿè¡Œ
æœ¬å‡¦ç†ã§ã™ã€‚

#### createRequestPrompt
LLMã«ä¸ãˆã‚‰ã‚Œã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ä¸‹è¨˜ã§ã™ã€‚
```
You are a service that translates user requests into JSON objects of type "SentimentResponse" according to the following TypeScript definitions:

    ```
    // The following is a schema definition for determining the sentiment of a some user input.
    
    export interface SentimentResponse {    
    sentiment: "negative" | "neutral" | "positive";  
    // The sentiment of the text
    }
    ```

The following is a user request:"""`ã“ã‚“ã«ã¡ã¯ï¼"""

The following is the user request translated into a JSON object with 2 spaces of indentation and no properties with the value undefined:
```

#### complete
completeã®çµæœã¯ä¸‹è¨˜ã¨ãªã‚Šã¾ã—ãŸã€‚
```ts
'{\n  "sentiment": "neutral"\n}'
```

#### validate
##### JSONã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
å•é¡Œãªãé€šéã—ã¾ã—ãŸã€‚
![](https://storage.googleapis.com/zenn-user-upload/ef355bdd6f26-20230801.png)

##### å‹ãƒã‚§ãƒƒã‚¯
`validator.createModuleTextFromJson`ã§æ¬¡ã®ã‚ˆã†ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒã§ãã¾ã™ã€‚

```ts
import { SentimentResponse } from './schema';
const json: SentimentResponse = {
  "sentiment": "neutral"
};
```

ã“ã‚Œã§å‹ãƒã‚§ãƒƒã‚¯ã‚’é€šéã—ã€çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```sh
ğŸ˜€> ã“ã‚“ã«ã¡ã¯!
The sentiment is neutral
```

--- 

### programã®å ´åˆ
æœ¬æ–‡ã§ã‚‚è§¦ã‚Œã¦ã„ã¾ã™ãŒã€é–¢æ•°å®Ÿè¡Œã‚’ä¼´ã†`math.ts`ã®å‡¦ç†ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚

```examples/math/src/main.ts
import fs from "fs";
import path from "path";
import dotenv from "dotenv";
import { createLanguageModel, processRequests, createProgramTranslator, evaluateJsonProgram, getData } from "typechat";

// TODO: use local .env file.
dotenv.config({ path: path.join(__dirname, "../../../.env") });

const model = createLanguageModel(process.env);
const schema = fs.readFileSync(path.join(__dirname, "mathSchema.ts"), "utf8");
const translator = createProgramTranslator(model, schema);

// Process requests interactively or from the input file specified on the command line
processRequests("â•â–âœ–ï¸â—ğŸŸ°> ", process.argv[2], async (request) => {
    const response = await translator.translate(request);
    if (!response.success) {
        console.log(response.message);
        return;
    }
    const program = response.data;
    console.log(getData(translator.validator.createModuleTextFromJson(program)));
    console.log("Running program:");
    const result = await evaluateJsonProgram(program, handleCall);
    console.log(`Result: ${typeof result === "number" ? result : "Error"}`);
});

async function handleCall(func: string, args: any[]): Promise<unknown> {
    console.log(`${func}(${args.map(arg => typeof arg === "number" ? arg : JSON.stringify(arg, undefined, 2)).join(", ")})`);
    switch (func) {
        case "add":
            return args[0] + args[1];
        case "sub":
            return args[0] - args[1];
        case "mul":
            return args[0] * args[1];
        case "div":
            return args[0] / args[1];
        case "neg":
            return -args[0];
        case "id":
            return args[0];
    }
    return NaN;
}
```
https://github.com/microsoft/TypeChat/blob/b380488c807f6676e88ccf3e9469b4e8f1b170b0/examples/math/src/main.ts#L1

#### 1. TypeChatJsonTranslatorã®ä½œæˆ
å‰ã®ä¾‹ã¨å¤§åŒå°ç•°ã§ã™ãŒã€**createProgramTranslator**ã‚’ä½¿ã£ã¦ã„ã‚‹ç‚¹ãŒç•°ãªã‚Šã¾ã™ã€‚

**createProgramTranslator**ã«ã‚ˆã£ã¦ã€**Program**å‹ã«æ²¿ã£ãŸå‡¦ç†ã‚’è¡Œå³ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
dotenv.config({ path: path.join(__dirname, "../../../.env") });

const model = createLanguageModel(process.env);
const schema = fs.readFileSync(path.join(__dirname, "mathSchema.ts"), "utf8");
const translator = createProgramTranslator(model, schema);
```

å¼•æ•°ã®schemaã‚‚**API**ã¨ã„ã†å‹åã§ã®é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£ã«ãªã£ã¦ã„ã¾ã™ã€‚

```mathSchema.ts
export type API = {
    // Add two numbers
    add(x: number, y: number): number;
    // Subtract two numbers
    sub(x: number, y: number): number;
    // Multiply two numbers
    mul(x: number, y: number): number;
    // Divide two numbers
    div(x: number, y: number): number;
    // Negate a number
    neg(x: number): number;
    // Identity function
    id(x: number): number;
    // Unknown request
    unknown(text: string): number;
}

```

#### 2. å…¥åŠ›
å‰ã®ä¾‹ã¨åŒæ§˜ã«ã€å…¥åŠ›ã‚’callbacké–¢æ•°ã«æµã—ã¾ã™ã€‚

ä¸‹è¨˜ã‚’å…¥åŠ›ã—ã¾ã—ãŸã€‚

>multiply two by three, then multiply four by five, then sum the results

#### 3. translateã®å®Ÿè¡Œ
##### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
**createProgramTranslator**ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§LLMã¸ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ï¼ˆäººé–“ãŒèª­ã¿ã‚„ã™ã„ã‚ˆã†ã«æ‰‹ã‚’å…¥ã‚Œã¦ã„ã¾ã™ã€‚ï¼‰

```txt
You are a service that translates user requests into programs represented as JSON using the following TypeScript definitions:
    
    ```
    // A program consists of a sequence of function calls that are evaluated in order.
    
    export type Program = {
        "@steps": FunctionCall[];
    }
    
    // A function call specifies a function name and a list of argument expressions. Arguments may contain// nested function calls and result references.
    export type FunctionCall = {
        // Name of the function
        "@func": string;
        // Arguments for the function, if any
        "@args"?: Expression[];
    };

    // An expression is a JSON value, a function call, or a reference to the result of a preceding expression.
    export type Expression = JsonValue | FunctionCall | ResultReference;

    // A JSON value is a string, a number, a boolean, null, an object, or an array. Function calls and result// references can be nested in objects and arrays.
    export type JsonValue = string | number | boolean | null | { [x: string]: Expression } | Expression[];

    // A result reference represents the value of an expression from a preceding step.
    export type ResultReference = {
        // Index of the previous expression in the "@steps" array
        "@ref": number;};

    ```

The programs can call functions from the API defined in the following TypeScript definitions:

    ```
    // This is a schema for writing programs that evaluate expressions.export type API = {
        // Add two numbers
        add(x: number, y: number): number;
        // Subtract two numbers
        sub(x: number, y: number): number;
        // Multiply two numbers
        mul(x: number, y: number): number;
        // Divide two numbers
        div(x: number, y: number): number;
        // Negate a number
        neg(x: number): number;
        // Identity function
        id(x: number): number;
        // Unknown request
        unknown(text: string): number;}
    ```

The following is a user request:

"""multiply two by three, then multiply four by five, then sum the results"""

The following is the user request translated into a JSON program object with 2 spaces of indentation and no properties with the value undefined:
```


#### OpenAIã®å›ç­”
ä¸Šè¨˜ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¯¾ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªå›ç­”ãŒè¿”ã£ã¦ãã¾ã—ãŸã€‚

**Program**å‹ã«æ²¿ã£ã¦ã€`@func`ã‚„`@args`ã€`@ref`ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚

```json
{
  "@steps": [
    {
      "@func": "mul",
      "@args": [2,3]
    },
    {
      "@func": "mul",
      "@args": [4,5]
    },
    {
     "@func": "add",
     "@args": [{ "@ref": 0 },{ "@ref": 1 }
      ]
    }
  ]
}
```

#### validate
`Program`å‹ã‹ã‚‰TypeScriptã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œã‚Šã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¾ã™ã€‚

ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã¨ã€ä¸‹è¨˜ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã¨ãªã‚Šã¾ã™ã€‚
```ts
import { API } from "./schema";
function program(api: API) {
  const step1 = api.mul(2, 3);
  const step2 = api.mul(4, 5);
  return api.add(step1, step2);
}
```

#### å®Ÿè¡Œï¼ˆevaluateJsonProgramï¼‰
å‹ãƒã‚§ãƒƒã‚¯ãŒé€šã£ãŸã‚‰ã€æœ€å¾Œã«å®Ÿè¡Œã§ã™ã€‚

Programã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰é–¢æ•°åã¨å¼•æ•°ã‚’å–ã‚Šå‡ºã—ã€`handleCall`ã«æ¸¡ã—ã¾ã™ã€‚

```ts
async function handleCall(func: string, args: any[]): Promise<unknown>
```
å¼•æ•°ã«ä¸ãˆã‚‰ã‚ŒãŸé–¢æ•°åã¨å¼•æ•°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã§ãã¾ã™ã€‚

```sh
mul(2, 3)
mul(4, 5)
add(6, 20)
Result: 26
```

ã¨ãªã£ã¦ã€Schemaã§å®šç¾©ã—ãŸé–¢æ•°ãŒæ­£ã—ã„ã‚·ã‚°ãƒãƒãƒ£ã§å‘¼ã°ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

# ãŠã‚ã‚Šã«
TypeChatã®ä»•çµ„ã¿ã«ã¤ã„ã¦ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ä¸€é€šã‚Šè¦‹ã¦ã¿ã¾ã—ãŸã€‚

ãƒã‚¤ãƒ³ãƒˆã¯`validate.ts`ã§ã®TypeScriptã®ä½œæˆã€œJSONã®å‹ãƒã‚§ãƒƒã‚¯ã§ã€ãƒ¡ã‚¿ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã«ãªã£ã¦ã„ã‚‹ã®ãŒé¢ç™½ã„ã§ã™ã€‚

**Program**å‹ã«ã‚ˆã‚‹é–¢æ•°å®Ÿè¡Œã¯ChatGPTã®Function Callingã¨å¤§ã¾ã‹ãªä»•çµ„ã¿ã¯åŒã˜ã§ã€ã„ã‹ã«æ­£ã—ãé–¢æ•°åã¨å¼•æ•°ã‚’æ‰‹ã«å…¥ã‚Œã‚‹ã‹ã€ã¨ã„ã†ã¨ã“ã‚ã§ã€TypeScriptã®å‹ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ã†ã‹ã€JSONã‚¹ã‚­ãƒ¼ãƒã‚’ä½¿ã†ã‹ã€ã®é•ã„ã€ã¨ç†è§£ã—ã¾ã—ãŸã€‚

Function callingã§ã‚‚æƒ³å®šå¤–ã®JSONãŒè¿”ã£ã¦ãã¦ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ãŒã‚ã£ãŸã®ã§ã€ã‚ˆã‚Šå …ç‰¢ãªLLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«TypeChatã¯ä¸€ã¤ã®é¢ç™½ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã ã¨æ„Ÿã˜ã¾ã—ãŸã€‚


## å‚è€ƒè¨˜äº‹

https://note.com/schroneko/n/n7065a1faed36
