---
title: "ã€Google Apps Scriptã€‘Gmailã‹ã‚‰ã€Œç›¸æ‰‹ã‹ã‚‰ã®è¿”ä¿¡å¾…ã¡ãƒ¡ãƒ¼ãƒ«ã€ã‚’æŠ½å‡ºã™ã‚‹"
emoji: "ğŸ“¨"
type: "tech"
topics:
  - "tips"
  - "gas"
  - "gmail"
  - "googleappsscript"
published: true
published_at: "2022-07-25 08:25"
---

# ã¯ã˜ã‚ã«

å¤ã€‚ç¹å¿™æœŸã€‚æ—¥ã¯ã¨ã†ã«æš®ã‚ŒãŸã€‚

ã¾ãŸãƒ¡ãƒ¼ãƒ«ã‹ã€‚å—ä¿¡ãƒœãƒƒã‚¯ã‚¹ã¯ã¨ã†ã«æº¢ã‚Œã¦ã„ã‚‹ã€‚

>ä¸Šå¸:ã€Œã‚ãŸã—å®›ã¦ã®ãƒ¡ãƒ¼ãƒ«ã«24æ™‚é–“ä»¥å†…ã«è¿”ä¿¡ãŒãªã‹ã£ãŸã‚‰ãƒªãƒã‚¤ãƒ³ãƒ‰ã—ã¦ã­ã€

å¿ƒã®æ‚ªé­”ãŒå›ãã€‚

>ã€Œã‚ã®ã€äººã‚’ãƒªãƒã‚¤ãƒ³ãƒ‰ä»£ã‚ã‚Šã«ä½¿ã†ã®ã‚„ã‚ã¦ãã‚Œã¾ã™ï¼Ÿã€

ã€Œãƒ”ã‚·ãƒƒã€ãƒ”ã‚·ãƒƒã€ãƒ”ã‚·ãƒƒã€ã€‚è€³ã«ä¼ã†ã‚ˆã†ã«æ¥ã‚‹ã®ã¯ã€äººé–“é–¢ä¿‚ã«äº€è£‚ãŒèµ°ã‚‹éŸ³...
:::message
â€»ä¸Šè¨˜ã¯ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚å®Ÿåœ¨ã®äººç‰©ãƒ»çµ„ç¹”ã€ã¨ã‚Šã‚ã‘ç§ã®ä¸Šå¸ãªã©ã¨ã¯é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚
:::
---

ç­†è€…ã¯Gmailã®å—ä¿¡ãƒˆãƒ¬ã‚¤ã‚’éƒ½åº¦ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã™ã‚‹ã“ã¨ã§ToDoç®¡ç†ã‚’ã—ã¦ã„ã¾ã™ãŒã€[^1]
ç¹å¿™æœŸã«ãªã‚‹ã¨å—ä¿¡ãƒˆãƒ¬ã‚¤ã®ä¸€é€šä¸€é€šã¾ã§è¿½ã„åˆ‡ã‚Œãªããªã‚Šã¾ã™ã€‚
[^1]:[ã“ã‚“ãªå…·åˆ](https://www.itmedia.co.jp/bizid/articles/0906/24/news088.html)ã€‚å°‘ã—ã¥ã¤githubã®issueç®¡ç†ã«ç§»è¡Œä¸­ã€‚

ã“ã“ã«ãã¦ã€
>ã€Œã‚ãŸã—å®›ã¦ã®ãƒ¡ãƒ¼ãƒ«ã«24æ™‚é–“ä»¥å†…ã«è¿”ä¿¡ãŒãªã‹ã£ãŸã‚‰ãƒªãƒã‚¤ãƒ³ãƒ‰ã—ã¦ã­ã€

ã¨æ¥ã‚‹ã¨ã•ã™ãŒã«ã‚­ãƒ£ãƒ‘ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚ãã“ã§Google Apps Scriptã§ä¸Šå¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿œãˆã¦ã¿ãŸã€ã¨ã„ã†ãŠè©±ã§ã™ã€‚

# ç›®æ¨™
>ã€Œã‚ãŸã—å®›ã¦ã®ãƒ¡ãƒ¼ãƒ«ã«24æ™‚é–“ä»¥å†…ã«è¿”ä¿¡ãŒãªã‹ã£ãŸã‚‰ãƒªãƒã‚¤ãƒ³ãƒ‰ã—ã¦ã­ã€

ã‚’Google Apps Scriptã§å®Ÿè£…ã™ã‚‹ã€‚

å…·ä½“çš„ã«ã¯ä¸‹è¨˜ã®æ¡ä»¶ã‚’ã™ã¹ã¦æº€ãŸã™ãƒ¡ãƒ¼ãƒ«ã‚’æŠ½å‡ºã™ã‚‹ã€‚

## æŠ½å‡ºæ¡ä»¶
1. é€ä¿¡æ—¥ã‹ã‚‰24æ™‚é–“ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹ã€‚
1. ã‚¹ãƒ¬ãƒƒãƒ‰ã®æœ€å¾Œã®ãƒ¡ãƒ¼ãƒ«ã®å®›å…ˆãŒç‰¹å®šã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãªã£ã¦ã„ã‚‹ã€‚
1. ã‚¹ãƒ¬ãƒƒãƒ‰ã®æœ€å¾Œã®ãƒ¡ãƒ¼ãƒ«ã®å·®å‡ºäººãŒè‡ªåˆ†
1. æœ€çµ‚ãƒ¡ãƒ¼ãƒ«ã«â˜†ãƒãƒ¼ã‚¯ãŒã¤ã„ã¦ã„ãªã„
â€»ã€Œã”ç¢ºèªã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ã€ã®ã‚ˆã†ãªè¦è¿”ä¿¡ã§ãªã„ãƒ¡ãƒ¼ãƒ«ã‚’é™¤å¤–ã™ã‚‹ãŸã‚ã€‚

# ä½¿ã†ã‚‚ã®
- Gmailã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
- Google Apps Script
ã€€ã€€- GmailAppã‚¯ãƒ©ã‚¹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã„ã¾ã™ã€‚
ã€€ã€€https://developers.google.com/apps-script/reference/gmail/gmail-app

## ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹è¨˜äº‹
[Find Unanswered Emails with Apps Script](https://gsuite-developers.googleblog.com/2014/05/find-unanswered-emails-with-apps-script.html)
2014å¹´5æœˆã®è¨˜äº‹ã€‚ã“ã‚Œã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãƒ»ã‚«ã‚¹ã‚¿ãƒ ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚

# å®Ÿè£…
## 1. ã€Œ24æ™‚é–“ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹ã€ã€Œç‰¹å®šã®å®›å…ˆã®ã€ãƒ¡ãƒ¼ãƒ«ã‚’æŠ½å‡º
æ¡ä»¶ã«è©²å½“ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã¯[GmailApp.search(query)](https://developers.google.com/apps-script/reference/gmail/gmail-app#searchquery)ã§æŠ½å‡ºã§ãã¾ã™ã€‚

å¼•æ•°ã®`query`ã¯ã€Gmailä¸Šã§æ¤œç´¢ã™ã‚‹ã®ã¨åŒã˜æ›¸å¼ã§OKã€‚
:::message
Gmailã®æ¤œç´¢ã§ä½¿ãˆã‚‹æ¤œç´¢æ¼”ç®—å­ã¯ã“ã¡ã‚‰ã‚’å‚ç…§ã®ã“ã¨ã€‚
https://support.google.com/mail/answer/7190?hl=ja
Andæ¡ä»¶ã¯åŠè§’ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã€Oræ¡ä»¶ã¯`OR ã¾ãŸã¯ { }`ã§æ›¸ã‘ã¾ã™ã€‚
:::

ã¾ãšã¯ã€**ã€Œ24æ™‚é–“ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹ã€ã€Œç‰¹å®šã®å®›å…ˆã®ã€** ã®2æ¡ä»¶ã§ä¸‹è¨˜ã®`query`ã‚’ä½œã‚Šã¾ã™ã€‚ï¼ˆ2022/07/23ã«å®Ÿè¡Œã®å ´åˆï¼‰

```
in:sent before:2022/07/22 to:sample@example.com
```

ã“ã‚Œã ã¨æ¤œç´¢å¯¾è±¡ãŒå‰æ—¥ä»¥å‰ã®å…¨æœŸé–“ã«ãªã‚Šè†¨å¤§ãªã®ã§ã€æ¤œç´¢ç¯„å›²ã‚’1é€±é–“ã«é™å®šã—ã€

```
in:sent after:2022/07/16 before:2022/07/22 to:sample@example.com
```

ã¨ã—ã¾ã™ã€‚

ãŸã ã€ã“ã‚Œã ã¨ã‚„ã‚„å•é¡ŒãŒã‚ã£ã¦ã€æ—¥æ™‚æŒ‡å®šã§`query`ã‚’æ¸¡ã™ã¨ã€ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãŒUTCã«ãªã‚‹ã‚ˆã†ã§ã™ã€‚([å‚è€ƒ](https://groups.google.com/g/google-apps-script-community/c/heK3-B0oEbM))
[Gmail APIã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰](https://groups.google.com/g/google-apps-script-community/c/heK3-B0oEbM)ã®ã¨ãŠã‚Šã€UNIXæ™‚é–“ã«å¤‰æ›ã™ã‚‹ã“ã¨ã§`GmailApp.search`ã§ã‚‚æ—¥æœ¬æ™‚é–“ã«å¯¾å¿œã§ãã¾ã™ã€‚

:::message
- new Dateã§æ—¥æœ¬æ™‚é–“ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€`appscript.json`ã§`"timeZone": "Asia/Tokyo"`ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
- æœŸé–“æŒ‡å®šã«ã¯ã€`older_than:`ã€`newer_than:`ã‚‚ä½¿ãˆãã†ã§ã™ãŒã€ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã«ã¤ã„ã¦ã¯æœªæ¤œè¨¼ã§ã™ã€‚
:::

ä»¥ä¸Šã‚’ã‚‚ã¨ã«`query`çµ„ã¿ç«‹ã¦ã¾ã™ã€‚

```js
ã€€//ç‰¹å®šã®å®›å…ˆã®ãƒ¡ãƒ¼ãƒ«ã«æ¤œç´¢ã‚’é™å®šã—ãŸã„å ´åˆã¯æŒ‡å®šã™ã‚‹ã€‚
  const toEmailAddress = []

  //å¼•æ•°ã®æ—¥æ•°åˆ†å‰ã®æ—¥ä»˜ã‚’è¿”ã™é–¢æ•°
  const daysBefore = (days) => {
    const d = new Date();
    d.setDate(d.getDate() - days);
    const unixTime = Date.parse(d)/1000
    return unixTime.toFixed()
  }

  let query = `in:sent after:${daysBefore(7)} before:${daysBefore(1)}`
  if (toEmailAddress.length > 0) {
    toEmailAddress.forEach((email) => {
      query += ` to:${email}`
    }
    )
  }
  console.log(`Search query:${query}`)
```

`query`ãŒã§ããŸã‚‰ã€`GmailApp.search(query)`ã§ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’æ¤œç´¢ã—ã¾ã™ã€‚
```js
  const threads = GmailApp.search(query);
```
ã“ã‚Œã§queryã«è©²å½“ã™ã‚‹GmailThreadã‚¯ãƒ©ã‚¹ã®é…åˆ—ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚

:::message alert
å½“åˆã€Œâœ…ãŒã¤ã„ã¦ã„ãªã„ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é™¤å¤–ã®ã€Œ-ã€ã‚’ä½¿ã£ã¦ **-has:green-check** ã§çµã‚Šè¾¼ã¿ã‚’ã—ã‚ˆã†ã¨ã—ã¾ã—ãŸãŒã€**GmailApp.search(query)** ã§ã¯åŠ¹ã‹ãªã„ã‚ˆã†ã§ã™ã€‚
:::

## 2. ã€Œæœ€å¾Œã®å·®å‡ºäººãŒè‡ªåˆ†ã§ã‚ã‚‹ã‚‚ã®ã€ã€Œâ˜†ãƒãƒ¼ã‚¯ãªã—ã€ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’æŠ½å‡º
ç¶šã„ã¦ã€`thread.getMessages()[thread.getMessageCount() - 1]`ã§ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã®æœ€å¾Œã®ãƒ¡ãƒ¼ãƒ«ã‚’å–å¾—ã—ã€å·®å‡ºäººãŒè‡ªåˆ†ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã‚ã‚‹ã‚‚ã®ã«çµã‚Šè¾¼ã¿ã¾ã™ã€‚

[Session.getEffectiveUser().getEmail()](https://developers.google.com/apps-script/reference/base/session#getActiveUser())ã¯ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿”ã—ã¾ã™ã€‚

```js
ã€€//é€ä¿¡å…ƒãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æŒ‡å®š
  const userEmailAddress = Session.getEffectiveUser().getEmail();
  //æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã©ã†ã‹åˆ¤å®šã™ã‚‹æ­£è¦è¡¨ç¾
  const emailRegex = /[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-z.A-Z]+/g;

  const threadsToUpdate = [];
  for (let i = 0; i < threads.length; i++) {
    const thread = threads[i];
    const lastMessage = thread.getMessages()[thread.getMessageCount() - 1];
    const lastMessageSender = lastMessage.getFrom().match(emailRegex)[0];
    if (lastMessageSender == userEmailAddress && !lastMessage.isStarred()) {
      threadsToUpdate.push(thread);
    }
  }
```

## 3. ãƒ©ãƒ™ãƒ«ã®ä½œæˆãƒ»è¿½åŠ 
æœ€å¾Œã«æŠ½å‡ºã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ã«**ãƒ©ãƒ™ãƒ«ä»˜ã‘**ã‚’è¡Œã„ã¾ã™ã€‚

ã™ã§ã«ãƒ©ãƒ™ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã€æ—¢å­˜ã®ãƒ©ãƒ™ãƒ«ã®å‰Šé™¤ã—ã€ãƒ©ãƒ™ãƒ«ä»˜ã‘ã‚’æ›´æ–°ã—ã¾ã™ã€‚
ãƒ©ãƒ™ãƒ«ã®ä½œæˆã¯ã€[GmailApp.createLabel](https://developers.google.com/apps-script/reference/gmail/gmail-app#createLabel(String))ã‚’ç”¨ã„ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã¸ã®ãƒ©ãƒ™ãƒ«ã®è¿½åŠ ã¯ã€[GmailLabel.addToThreads(threads)](https://developers.google.com/apps-script/reference/gmail/gmail-label#addToThreads(GmailThread))ã‚’ç”¨ã„ã¾ã™ã€‚

```js
ã€€//å¤ã„ãƒ©ãƒ™ãƒ«ã®å‰Šé™¤
  const old_label = GmailApp.getUserLabelByName("è¿”ä¿¡å¾…ã¡");
  if (old_label) {
    GmailApp.deleteLabel(old_label);
  }

  const label = GmailApp.createLabel("è¿”ä¿¡å¾…ã¡");
  label.addToThreads(threadsToUpdate);
```

ã“ã‚Œã‚’**ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒˆãƒªã‚¬ã§æ—¥æ¯ã«å®Ÿè¡Œ**ã™ã‚‹ã¨ã€éå»1é€±é–“ï½24æ™‚é–“ã®ãƒ¡ãƒ¼ãƒ«ã«ãƒ©ãƒ™ãƒ«ãŒä»˜ãã€ç›®çš„ã®ãƒ¡ãƒ¼ãƒ«ã‚’æŠ½å‡ºã§ãã¾ã—ãŸã€‚

# ãŠã‚ã‚Šã«
ä»¥ä¸Šã®ã‚³ãƒ¼ãƒ‰ã‚’ã¾ã¨ã‚ã¦æç¤ºã—ã¾ã™ã€‚

```js
function findUnansweredMail() {
  //ç‰¹å®šã®å®›å…ˆã®ãƒ¡ãƒ¼ãƒ«ã«æ¤œç´¢ã‚’é™å®šã—ãŸã„å ´åˆã¯æŒ‡å®šã™ã‚‹ã€‚
  const toEmailAddress = []

  //å¼•æ•°ã®æ—¥æ•°åˆ†å‰ã®æ—¥ä»˜ã‚’è¿”ã™é–¢æ•°
  const daysBefore = (days) => {
    const d = new Date();
    d.setDate(d.getDate() - days);
    const unixTime = Date.parse(d)/1000
    return unixTime.toFixed()
  }

  let query = `in:sent after:${daysBefore(7)} before:${daysBefore(1)}`
  if (toEmailAddress.length > 0) {
    toEmailAddress.forEach((email) => {
      query += ` to:${email}`
    }
    )
  }
  console.log(`Search query:${query}`)

  const threads = GmailApp.search(query);
  if (threads.length == 0) {
    return
  }

  //é€ä¿¡å…ƒãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æŒ‡å®š
  const userEmailAddress = Session.getEffectiveUser().getEmail();
  //æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã©ã†ã‹åˆ¤å®šã™ã‚‹æ­£è¦è¡¨ç¾
  const emailRegex = /[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-z.A-Z]+/g;

  const threadsToUpdate = [];
  for (let i = 0; i < threads.length; i++) {
    const thread = threads[i];
    const lastMessage = thread.getMessages()[thread.getMessageCount() - 1];
    const lastMessageSender = lastMessage.getFrom().match(emailRegex)[0];
    if (lastMessageSender == userEmailAddress && !lastMessage.isStarred()) {
      threadsToUpdate.push(thread);
    }
  }

  //å¤ã„ãƒ©ãƒ™ãƒ«ã®å‰Šé™¤
  const old_label = GmailApp.getUserLabelByName("è¿”ä¿¡å¾…ã¡");
  if (old_label) {
    GmailApp.deleteLabel(old_label);
  }

  const label = GmailApp.createLabel("è¿”ä¿¡å¾…ã¡");

  label.addToThreads(threadsToUpdate);
}
```

[GmailApp](https://developers.google.com/apps-script/reference/gmail/gmail-app)ã®å„ç¨®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¦šãˆã¦ãŠãã¨ã€ä»Šå›ã®ä¾‹ã®ä»–ã«ã‚‚ã€Œæœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè‡ªåˆ†å®›ã¦ã«ãªã£ã¦ã„ã‚‹ã€ã¨ã„ã£ãŸæ¡ä»¶ã§æœªè¿”ä¿¡ãƒ¡ãƒ¼ãƒ«ã‚’æŠ½å‡ºã—ãŸã‚Šã¨ã€ã„ã‚ã„ã‚å¿œç”¨ãŒåŠ¹ãã¾ã™ã­ã€‚[Gmailã§ä½¿ãˆã‚‹æ¤œç´¢æ¼”ç®—å­](https://support.google.com/mail/answer/7190?hl=ja)ãŒå¤šå°‘ã‚„ã£ã‹ã„ã§ã™ãŒã€ãƒ•ã‚£ãƒ«ã‚¿æ¤œç´¢ã§ã‚‚ä½¿ãˆã‚‹ã®ã§è¦šãˆã¦ãŠã„ã¦æã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

Gmailã‚’Google Apps Scriptã§æ›¸ãè¨˜äº‹ã¯ãƒãƒƒãƒˆä¸Šã«å¤šãã‚ã‚Šã¾ã™ãŒã€æ¥­å‹™ä¸Šã®å®Ÿéš›ã®æ´»ç”¨ä¾‹ã¨ã—ã¦ã”å‚è€ƒãã ã•ã„ã€‚